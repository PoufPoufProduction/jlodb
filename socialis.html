<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Genius Socialis</title>
    <script type="text/javascript" src="js/jquery-1.8.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.23.custom.min.js"></script>
    <script type="text/javascript" src="js/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="js/jquery.svg.min.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.jlodb.js"></script>
    <script type="text/javascript" src="js/jquery.jlodb.menu.js"></script>
    <script type="text/javascript" src="js/jlodb-ext.js"></script>
    <script type="text/javascript" src="mods/genius/js/jquery.jlodb.genius.js"></script>
    <script type="text/javascript" src="gonz/jquery.gonz.js"></script>
    <link type="text/css" rel="stylesheet" href="css/jlodb.css" media="all" />
    <link type="text/css" rel="stylesheet" href="css/user.css" media="all" />
    <link type="text/css" rel="stylesheet" href="mods/socialis/style.css" media="all" />
    <link rel="apple-touch-icon-precomposed" href="mods/socialis/res/img/icon/icon144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="mods/socialis/res/img/icon/icon72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="mods/socialis/res/img/icon/icon114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="mods/socialis/res/img/icon/icon144.png" />
    <meta name="apple-mobile-web-app-capable" content="yes"/>

    <script>

var socialis = {
    settings: {
        lang    : "",       // Current langage
        user    : {},       // User settings (id, first name, last name, email, avatar)
        avatar  : "",       // Modified avatar (before save)
        ask     : 0,        // Number of ask for friendship
        logout  : 0         // Logout timer
    },
    activity: "",
    finished: false,
    locale  : {},
    menu    : function() { socialis.activity=""; if (socialis.finished) { var state = $("#genius #board").genius('finish'); } },
    state   : function() { $("#genius #board").genius('states'); },
    format  : function(_text) {
        var regNode = new RegExp("\\\[node\\\]([0-9]+)\\\[/node\\\]","g");
        var match = regNode.exec(_text);
        _text = _text.replace(regNode, function(_val, _p1) {
            $.getJSON("mods/genius/api/node.php?id="+_p1, function(_data) {
                $("#fmt"+_data.id).html(_data.name);
            });
            return "<span id='fmt"+_p1+"' class='nodeln' onclick='socialis.node("+_p1+");' "+
                   "ontouchstart='socialis.node("+_p1+");event.preventDefault();'>"+_p1+"</span>"; });

        var regBold = new RegExp("\\\[b\\\]([^\\\[]+)\\\[/b\\\]","g");
        _text = _text.replace(regBold,"<b>$1</b>");

        var regBlink = new RegExp("\\\[blink\\\]([^\\\[]+)\\\[/blink\\\]","g");
        _text = _text.replace(regBlink,"<span class='blink"+Math.floor(Math.random()*4+1)+"'>$1</span>");

        var regBlue = new RegExp("\\\[blue\\\]([^\\\[]+)\\\[/blue\\\]","g");
        _text = _text.replace(regBlue,"<b class='blue'>$1</b>");

        return _text;
    },
    node: function(_id) {
        if ($("#news").is(":visible")) { socialis.news.close(); }
        if ($("#awards").is(":visible")) { socialis.awards.close(); }

        setTimeout(function() {
            $("#board").genius("svg","#"+_id).each(function() {
                if ($(this).attr("class").indexOf("available")!=-1) { $("#board").genius("node",_id); }
                else                                                { socialis.example.open($("#board"), _id, true); }
            });
        }, 800);
    },
    getJSON : function(_url, _args, _post, _cbk) {
        var cross = (_url.indexOf("http")==0);
        var url = _url+"?username="+$.cookie("jlodb-name")+
                    (cross?("&host="+document.URL.substr(0,document.URL.lastIndexOf("/")+1)):"&code="+$.cookie("jlodb-code"));

        if (typeof(_args)=="object") {  for (var i in _args) {
            if ($.isArray(_args[i])) {
                var urltmp=""; for (var j in _args[i]) {
                    if (urltmp.length) { urltmp+=","; }
                    if (typeof(_args[i][j])=="string")  { urltmp+="'"+_args[i][j]+"'"; }
                    else                                { urltmp+=_args[i][j]; }
                }
                url+="&"+i+"="+urltmp;
            }
            else { url+="&"+i+"="+_args[i]; }
        } }
        else if (_args.length) { url+=(_args[0]=='&'?"":"&")+_args; }

        //alert(url);
        if (_post || cross) {
            $.post(url, _post, function(_data) {if(_data.error==102){location.reload();} else { _cbk(_data); } }, "json");
        }
        else {
            $.getJSON(url, function(_data)     {if(_data.error==102){location.reload();} else { _cbk(_data); } });
        }
    },
    cyclic  : {
        timer   : 0,
        counter : 0,
        process: function() {
            if (socialis.cyclic.timer) { clearTimeout(socialis.cyclic.timer); socialis.cyclic.timer = 0; }
            socialis.cyclic.timer = setTimeout(socialis.cyclic.process, 5000);
            socialis.cyclic.counter++;
            if (!$("#launcher").is(":visible")) {
                if (socialis.cyclic.counter%20==1)  { socialis.cyclic.misc(); }
                if (socialis.cyclic.counter%6==1)   { socialis.cyclic.friend(); socialis.cyclic.tibibi(); }
                if (socialis.cyclic.counter%2==0)   { socialis.cyclic.highlight.start(); }
            }
        },
        highlight: {
            start: function() {
                $("#main>#genius #board").genius("svg",".node.available").each(function() {
                    if (!$("#main>#genius #board").genius("svg",".link.d"+$(this).attr("id")).length) {
                        $(this).attr("class",$(this).attr("class")+" highlight");
                    }
                });
                setTimeout(socialis.cyclic.highlight.run,100);
            },
            run: function() {
                var nb=0;
                $("#main>#genius #board").genius("svg",".node.highlight").each(function() {
                    $(this).attr("class",$(this).attr("class").replace(" highlight"," highlightdone"));
                    $("#main>#genius #board").genius("svg",".link.d"+$(this).attr("id")).each(function() {
                         $(this).attr("class",$(this).attr("class").replace(" highlight"," highlightdone"));
                    });
                    nb++;
                    $("#main>#genius #board").genius("svg",".link.s"+$(this).attr("id")).each(function() {
                        highlight = $(this).attr("class").split(" ")[2].substr(1);
                        var $highlight = $("#main>#genius #board").genius("svg","#"+highlight);
                        if ($highlight.attr("class").indexOf("highlight")==-1) {
                            $highlight.attr("class",$highlight.attr("class")+" highlight");
                            $(this).attr("class",$(this).attr("class")+" highlight");
                        }
                    });
                });
                if (nb) { setTimeout(socialis.cyclic.highlight.run,80); } else { setTimeout(socialis.cyclic.highlight.stop,80); }
            },
            stop: function() {
                $("#main>#genius #board").genius("svg",".highlight").each(function() {
                    $(this).attr("class",$(this).attr("class").replace(" highlight",""));
                });
                $("#main>#genius #board").genius("svg",".highlightdone").each(function() {
                    $(this).attr("class",$(this).attr("class").replace(" highlightdone",""));
                });
            }
        },
        friend: function() {
            socialis.getJSON("mods/socialis/api/friend.php", {action:"ask"}, "", function(_data) {
                var ask = _data.value?parseInt(_data.value):0;
                if (_data.status=="success" && _data.value) {
                    var value = ask<100?ask:"?";
                    if (ask!=socialis.settings.ask) {
                        $("#friend #asks").html("");
                        for (var i in _data.users) {
                            $("#friend #asks").append(socialis.friend.elt(_data.users[i], (_data.users.length<20), "accept"));
                        }
                        socialis.settings.ask = ask;
                    }
                }
                socialis.friend.ask();
            });
        },
        tibibi: function() {
            socialis.getJSON("mods/socialis/api/tibibi.php", {action:"new"}, "", function(_data) {
                if (_data.status=="success") {
                    $("#user #details #new").html(_data.value?_data.value:0).toggle(_data.value?true:false);
                }
            });
        },
        misc: function() {  },
    },
    score: {
        effect: function(_score) {
            $("#score .value").css("font-size","12em").css("opacity",0.1)
                                          .css("top",-0.4*$("#launcher").height())
                                          .css("left",0.04*$("#launcher").width())
                                          .animate({"font-size":"3em","opacity":1,
                                            "top":0.08*$("#launcher").height(),"left":0.25*$("#launcher").width()}, 500);
                        if (_score>2) {
                            setTimeout(function() {
                                var $old        = $("#score .splash01>div").detach();
                                var $new        = $old.clone();
                                $("#score .splash01").append($new.addClass("running")).show();
                                setTimeout(function(){$("#score .splash01>div").removeClass("running").parent().hide(); },800);
                                }, 500);
                            setTimeout(function() {
                                var $old        = $("#score .splash02>div").detach();
                                var $new        = $old.clone();
                                $("#score .splash02").append($new.addClass("running")).show();
                                setTimeout(function(){$("#score .splash02>div").removeClass("running").parent().hide(); },800);
                                }, 1000);
                        }
        }
    },
    example: {
        data: [],
        $this: 0,
        open: function($this, _id, _anim) {
                        $("#boardmask").css("opacity",1);
                        if (_anim)  { $("#boardmask>div").css("top","12em").css("opacity",0).animate({top:"9.5em",opacity:1},250); }
                        else        { $("#boardmask>div").css("top","9.5em").css("opacity",1); }
                        $("#boardmask h1").html("&nbsp;");
                        $("#boardmask #legend").html("");
                        $("#boardmask #source").html("");
                        $("#boardmask").show();

                        socialis.example.$this = $this;
                        var $c = $this.genius("svg","#"+_id);
                        var cClass = $c.attr("class");
                        $c.attr("class",cClass+" current");

                        $this.genius("svg",".d"+_id).each(function() {
                            var dClass = $(this).attr("class") + " source";
                            $(this).attr("class", dClass);

                            var s = dClass.match("link s([0-9]+) d[0-9]+ ");
                            var $elt = $this.genius("svg","#"+s[1]);
                            var eltClass = $elt.attr("class");
                            $elt.attr("class",eltClass+" source");

                            var html="<div id='i"+s[1]+"' class='item' ";
                            html+="onclick='socialis.example.close(false);socialis.example.open(socialis.example.$this,"+s[1]+",false);' ";
                            html+="ontouchstart='socialis.example.close(false);socialis.example.open(socialis.example.$this,"+s[1]+",false);event.preventDefault();'" ;
                            html+="></div>";
                            $("#boardmask #source").append(html);

                            socialis.getJSON("mods/genius/api/node.php",{id:s[1]}, function(_data) {
                                $("#boardmask #source #i"+_data.id).html(_data.name);
                            });

                        });


                        socialis.getJSON("mods/genius/api/node.php",{id:_id}, function(data) {
                            if(data.status=="success") {
                                $("#boardmask h1").html(data.name);

                                socialis.example.data = [];
                                if (data.exercices.length) { socialis.example.data = data.exercices.split(","); }

                                $("#boardmask #legend").html(socialis.example.data.length)
                            }
                        });
        },
        close: function(_hide) {
            if (_hide) { $("#boardmask").animate({opacity:0},500, function(){$("#boardmask").hide()}); }
            if (socialis.example.$this) {
                socialis.example.$this.genius("svg",".current").each(function() {
                    var sClass = $(this).attr("class");
                    $(this).attr("class",sClass.replace(" current",""));
                });
                socialis.example.$this.genius("svg",".source").each(function() {
                    var sClass = $(this).attr("class");
                    $(this).attr("class",sClass.replace(" source",""));
                });
            }
        },
        launch: function() {
            if (socialis.example.data.length) {
                var args = { id: socialis.example.data[Math.floor(Math.random()*socialis.example.data.length)] };
                $("body").removeClass("nosplash");
                $("#launcher").jlodb({
                    onstart:    function($this) {
                        setTimeout(function(){ if ($("#launcher").is(":visible")) { $("#genius").hide(); } },2000);
                    },
                    onfinish:   function($this) { $("#genius").show(); $("#score").removeClass().hide(); },
                    onscore:    function($this, _ret) {
                        $("#score #newreward").hide();
                        $("#score #reload").show();
                        $("#score #next").hide();
                        socialis.score.effect(_ret.score);

                        $("#score").attr("class","s"+_ret.score).show();
                        return true; }
                    },args);
                }
        }
    },
    awards: {
        status: true,
        data: {},
        current: -1,        // Current badge
        group: 0,           // Current group
        show : function() {
            $("#main>#awards").show();
            $("#awards>div").css("top","25em").css("opacity",0).animate({top:"0.5em",opacity:1}, 1000 );
        },
        pinuser: function(_data) {
            if (_data) { $("#user #avatar .badge").html("<img src='mods/socialis/res/img/badges/"+_data+".svg'/>").show(); }
            else { $("#user #avatar .badge").hide(); }
        },
        unreadbadges: function(_data, _update) {
                    var count = 0;
                    $("#awards .na").removeClass("na");
                    if (_data) for (var i in _data) {
                        $("#"+_data[i].type+" .lv2").each( function() {
                            if ($(this).find(".l").html()==_data[i].group) {
                                $(this).addClass("na").find(".n").html(_data[i].count);
                                $(this).parent().find(".title").addClass("na");
                                count+=_data[i].count;
                            }
                        });
                    }
                    $("#user #success.l").html(count).toggle(count!=0);
            if (socialis.awards.group && _update) { socialis.awards.overview(socialis.awards.group,false); }
        },
        build: function(_cbk) {
            if ($("#awards #menu").html().length==0) {
                socialis.getJSON("mods/socialis/api/award.php",{time:Math.floor(Math.random()*1000)}, function(_data) {
                    for (var i in _data.awards) {
                        var $title = $("#awards #menu #"+_data.awards[i].type);
                        if ($title.length==0) {
                            $title = $("<div id='"+_data.awards[i].type+"'><div class='title' "+
                                "ontouchstart='socialis.awards.menu(this,\""+_data.awards[i].type+"\");event.preventDefault();' " +
                                "onclick='socialis.awards.menu(this,\""+_data.awards[i].type+"\");'><div class='l'>"+
                                socialis.locale[_data.awards[i].type]+"</div><div class='n'>!</div></div></div>");
                            $("#awards #menu").append($title);
                        }
                        $title.append("<div class='lv2' ontouchstart='socialis.awards.overview(this,true);event.preventDefault();' "+
                                      "onclick='socialis.awards.overview(this,true);'><div class='l'>"+_data.awards[i].label+"</div>"+
                                      "<div class='n'></div></div>");
                    }
                    _cbk();
                });
            }
            else { _cbk(); }
        },
        open: function() {  socialis.awards.show(); },
        close: function() {
            $("#awards>div").animate({top:"25em",opacity:0},500, function() {$("#main>#awards").hide(); });
        },
        clear: function() {
            socialis.awards.group = 0;
            $("#awards #thumbnails").html("");
            $("#awards #detail #text").html("").removeClass("pinned"); socialis.awards.current=-1;
        },
        menu: function(_elt, _type) {
            socialis.awards.clear();
            if (socialis.awards.status) {
                $("#awards #menu .title").addClass("hide");
                $(_elt).removeClass("hide");
                $(_elt).parent().find(".lv2").addClass("show");
                $("#awards #menu .title.hide").animate({left:"-15em"},500, function() { $(this).hide(); });
                setTimeout(function() {
                    $("#awards #menu .lv2.show").show().css("opacity",0).animate({opacity:1},500);
                },800);
            }
            else {
                $("#awards #menu .lv2").removeClass("s").removeClass("show").hide();
                $("#awards #menu .title.hide").show().animate({left:"0"},500, function() { $(this).removeClass("hide"); });
            }
            socialis.awards.status = !socialis.awards.status;
        },
        overview: function(_elt,_read) {
            $("#awards #menu .lv2").removeClass("s");
            $(_elt).addClass("s");
            socialis.awards.clear();
            socialis.awards.group = _elt;
            socialis.getJSON("mods/socialis/api/award.php",{action:"look",value:encodeURIComponent($(_elt).find('.l').text()) },
            function(_data) {
                socialis.awards.data = _data.awards;
                var newawards=[];
                for (var i in _data.awards) {
                    var vImg = (_data.awards[i].state==0)?"locked":_data.awards[i].id;
                    var html="<div onclick='socialis.awards.detail(this,"+i+");' ";
                    html+="ontouchstart='socialis.awards.detail(this,"+i+");event.preventDefault();'>";
                    html+="<div class='icon'><img src='mods/socialis/res/img/badges/"+vImg+".svg'/></div>";
                    if (_data.awards[i].state==2) {
                        html+="<div class='nn'><img src='mods/socialis/res/img/award.svg'/></div>";
                        newawards.push(_data.awards[i].id);
                    }
                    html+="</div>";
                    $("#awards #thumbnails").append(html);
                }
                if (newawards.length && _read) {
                    socialis.getJSON("mods/socialis/api/award.php",{action:"read",value:newawards},
                        function(_data) { socialis.awards.unreadbadges(_data.unreadbadges, false); });
                }
            });
        },
        detail: function(_elt,_id) {
            socialis.awards.current=_id;
            if (_elt) { $("#awards #thumbnails>div").removeClass("s"); $(_elt).addClass("s"); }
            $("#awards #detail #text").html("<p>"+socialis.format(socialis.awards.data[_id].label)+"</p>");
            if (socialis.awards.data[_id].pinned=="1")  { $("#awards #detail #text").addClass("pinned"); }
            else                                        { $("#awards #detail #text").removeClass("pinned"); }
        },
        pin: function() {
            if (socialis.awards.current!=-1 && socialis.awards.data[socialis.awards.current].state!=0) {
                var newpinned="zzzzzz";
                if (socialis.awards.data[socialis.awards.current].pinned=="1") {
                    socialis.awards.data[socialis.awards.current].pinned="0";
                }
                else {
                    for (var i in socialis.awards.data) { socialis.awards.data[i].pinned="0"; }
                    socialis.awards.data[socialis.awards.current].pinned="1";
                    newpinned=socialis.awards.data[socialis.awards.current].id;
                }
                socialis.awards.detail(0,socialis.awards.current);
                socialis.getJSON("mods/socialis/api/award.php",{action:"pin",value:newpinned},
                        function(_data) { socialis.awards.pinuser(_data.pin); });
            }
        }
    },
    news: {
        open: function() {
            if (!$("#news #content").html().length) {
                socialis.getJSON("mods/socialis/news.json",{time:Math.floor(Math.random()*1000)}, function(_news) {
                    for (var i in _news) {
                        var html="<div class='news'><div class='newstitle'><div class='date'>"+_news[i].date+"</div>";
                        html+="<div class='title'>"+_news[i].title+"</div></div>";
                        html+="<div class='newsstory'>"+socialis.format( _news[i].story)+"</div></div>";
                        $("#news #content").append(html);
                    }
                    $("#main>#news").show();
                    $("#news>div").css("top","25em").css("opacity",0).animate({top:"0.5em",opacity:1}, 1000 );
                });
            }
            else {
                $("#main>#news").show();
                $("#news>div").css("top","25em").css("opacity",0).animate({top:"0.5em",opacity:1}, 1000 );
            }
        },
        close: function() {
            $("#news>div").animate({top:"25em",opacity:0},500, function() {$("#main>#news").hide(); });
        },
    },
    friend: {
        open: function() {
            if (socialis.friend.group.empty()) { socialis.friend.group.list( function() { socialis.friend.list(true); } ); }
            $("#main>#friend>div").css("left","30em").css("opacity",0).animate({left:"1em",opacity:1},500);
            $("#main>#friend").show();
        },
        close: function() {
            $("#main>#friend>div").animate({left:"30em",opacity:0},500, function() {$("#main>#friend").hide(); });
        },
        group: {
            settings: {
                name:""
            },
            timer: 0,
            del: function(_elt) {
                if (socialis.friend.group.timer==0) {
                    $(_elt).addClass("s");
                    socialis.friend.group.timer = setTimeout(function(){
                        $("#friend #delgroup").removeClass("s"); socialis.friend.group.timer = 0; }, 800);
                }
                else {
                    clearTimeout(socialis.friend.group.timer); socialis.friend.group.timer = 0;
                    $("#friend #delgroup").removeClass("s");
                    if (socialis.friend.group.settings.name) {
                        socialis.getJSON("mods/socialis/api/group.php", {action:"del", value:socialis.friend.group.settings.name}, 0, function(_data) {
                            socialis.friend.group.list( function() { $("#friend #menu #footer").removeClass("s");
                                                                     socialis.friend.list(false); }); });
                    }
                }
            },
            empty: function() { return ($("#friend #group").html().length==0);},
            add: function(_val) {
                if (_val && _val.length) {
                    socialis.getJSON("mods/socialis/api/group.php",{action:"new",value:_val}, "",
                        function(_data) { socialis.friend.group.list(function() {
                            $("#friend #group>div").each(function() {
                                if ($(this).html()==socialis.friend.group.settings.name) socialis.friend.group.click(this); });
                    }); });
                }
            },
            edit: function(_val) {
                if (_val && _val.length) {
                    socialis.getJSON("mods/socialis/api/group.php",{action:"upd",group:socialis.friend.group.settings.name,value:_val}, "",
                        function(_data) { socialis.friend.group.list(function() {
                            socialis.friend.group.settings.name = _val;
                            $("#friend #group>div").each(function() {
                                if ($(this).html()==socialis.friend.group.settings.name) socialis.friend.group.click(this); });
                    }); });
                }
            },
            list: function(_cbk) {
                socialis.getJSON("mods/socialis/api/group.php", "", 0, function(_data) {
                    if (_data.status=="success") {
                        $("#friend #group").html("");
                        for (var i in _data.groups) {
                            var html="<div class='e' onclick='socialis.friend.group.click(this);'>"+_data.groups[i]+"</div>";
                            $("#friend #group").append(html);
                        }

                        $("#friend #group .e").droppable({
                            drop:function(event, ui) {
                                if (!$(this).hasClass("s")) {
                                    var group = $(this).html();
                                    var friend = $(ui.helper).find(".id").html();
                                    $(ui.helper).detach();
                                    socialis.getJSON("mods/socialis/api/friend.php", { action:"group", group:group, value:friend}, "",
                                        function(_data) {
                                            if (_data.status=="success") { $(ui.draggable).detach(); }
                                    });
                                }
                            },
                            out:function(event, ui) { $(this).removeClass("o"); },
                            over:function(event, ui) { $(this).addClass("o"); }
                        });

                        if (_cbk) { _cbk(); }
                    }
                });
            },
            click: function(_elt) {
                if ($(_elt).hasClass("s")) {
                    $(_elt).removeClass("s");
                    $("#friend #menu #footer").removeClass("s");
                }
                else {
                    $("#friend #group>div").removeClass("s");
                    $(_elt).addClass("s");
                    $("#friend #menu #footer").addClass("s");
                }
                socialis.friend.list(false);
            },
            move: function(_up) {
                if ($("#friend #menu #footer").hasClass("s")) {
                    socialis.getJSON("mods/socialis/api/group.php", {action:_up?"up":"down",value:socialis.friend.group.settings.name}, 0,
                        function(_data) {
                            socialis.friend.group.list(function() {
                                $("#friend #group>div").each(function() {
                                    if ($(this).html()==socialis.friend.group.settings.name) socialis.friend.group.click(this);
                                });
                            });
                        });
                }
            }
        },
        accept:function()   { socialis.friend.refuse(); socialis.friend.list(socialis.friend.group.settings.name==""); },
        refuse:function()   { socialis.settings.ask--; socialis.friend.ask(); },
        del: function()     { },
        ask: function() {
            if (socialis.settings.ask) {
                $("#user #ask.l").html(socialis.settings.ask).show();
                $("#friend #view #ask").html(socialis.settings.ask).addClass("s");
            }
            else {
                $("#friend #asks").hide();
                $("#user #ask.l").html("").hide();
                $("#friend #view #ask").html("0").removeClass("s");
            }
        },
        list: function(_force) {
            var group = $("#friend #group>div.s").html(); if (!group) { group=""; }

            if (group!=socialis.friend.group.settings.name || _force) {
                socialis.friend.group.settings.name = group;
                socialis.getJSON("mods/socialis/api/friend.php",{ group:group }, "", function(_data) {
                    if (_data.status=="success") {
                        if (!_data.users || !_data.value) { $("#friend #list").html(""); }
                        else {
                            $("#friend #list").html("");
                            for (var i in _data.users) {
                                $("#friend #list").append(socialis.friend.elt(_data.users[i], (_data.users.length<=6), "friend"));
                            }

                            $("#friend #list .user").draggable({
                                distance:10, handle:".id", revert:true, stack:".user", appendTo:"#friend #group", helper:"clone",
                                start:function() { $(this).css("opacity",0.5); },
                                stop:function()  { $(this).css("opacity",1); $("#group>.e").removeClass("o"); }});
                        }
                    }
                });
            }
        },
        genius: function(_elt,_id) {
            $("#friend #genius #avatar").html($(_elt).closest(".user").find(".id").html());
            $("#friend #genius").show();
            $("#friend #genius #board").genius({
                onbuild: function($this) {
                    $.getJSON("mods/genius/api/state.php",function(data){
                        $this.genius('states',{nodes:data.nodes});

                        socialis.getJSON("mods/socialis/api/genius.php", {value:_id}, 0, function(_genius) {
                            if (_genius.genius.length) { $this.genius('states',{nodes:_genius.genius}); }
                        });
                    });
                },
                onnode:function ($this, _id, _available) { return false; }
            });

        },
        op: {
            timer: 0,
            id   : "",
            process: function(_elt, _id, _action, _cbk) {
                if (socialis.friend.op.timer==0) {
                    socialis.friend.op.id = _id;
                    $(_elt).addClass("s");
                    socialis.friend.op.timer = setTimeout(function(){
                        $("#friend .user .icon").removeClass("s"); socialis.friend.op.timer = 0; }, 800);
                }
                else if (_id==socialis.friend.op.id) {
                    clearTimeout(socialis.friend.op.timer); socialis.friend.op.timer = 0;

                    socialis.getJSON("mods/socialis/api/friend.php", {action:_action,value:_id}, 0, function(_data) {
                        $(_elt).closest(".user").detach();
                        if (_cbk) { _cbk(); }
                    });


                }
            }
        },
        elt: function(_user, _large, _type) {
            var ret=$("<div class='user"+(_large?"":" small")+"'></div>");
            if (_large) {
                var avatar = $("<div class='avatar'><div></div></div>");
                avatar.find("div").gonz({interactive:false, code:_user.avatar, context:{onclick:function($this){},onquit:function($this, _ret){}}});
                ret.append(avatar);
            }
            var legend=$("<div class='legend'></div>");
            legend.append("<div class='id'>"+_user.id+"</div>");
            legend.append("<div class='name'>"+_user.first+" "+_user.last+"</div>");
            legend.append("<div class='friendstar'><div class='icon'><img src='mods/socialis/res/img/star.svg'/></div>" +
                          "<div class='nbstars'>"+(_user.stars?_user.stars:0)+"</div></div>");
            if (_type=="add") {
                legend.append("<div class='icon' onclick='socialis.friend.op.process(this,\""+_user.id+"\",\"new\");'>"+
                              "<img src='mods/socialis/res/img/add.svg'/></div>");
            }
            else if (_type=="accept") {
                legend.append("<div class='icon' onclick='socialis.friend.op.process(this,\""+_user.id+"\",\"ok\",socialis.friend.accept);'>"+
                              "<img src='mods/socialis/res/img/valid.svg'/></div>");
                legend.append("<div class='icon'></div>");
                legend.append("<div class='icon' onclick='socialis.friend.op.process(this,\""+_user.id+"\",\"del\",socialis.friend.refuse);'>"+
                              "<img src='mods/socialis/res/img/cancel.svg'/></div>");
            }
            else if (_type=="friend") {
                legend.append("<div class='icon fdel' "+
                              "onclick='socialis.friend.op.process(this,\""+_user.id+"\",\"del\",socialis.friend.del);' "+
                              "ontouchstart='socialis.friend.op.process(this,\""+_user.id+"\",\"del\",socialis.friend.del);"+
                                            "event.preventDefault();'>"+
                              "<img src='mods/socialis/res/img/cancel.svg'/></div>");
                legend.append("<div class='icon' onclick='socialis.friend.genius(this,\""+_user.id+"\");' "+
                               "ontouchstart='socialis.friend.genius(this,\""+_user.id+"\");event.preventDefault();'>"+
                              "<img src='mods/socialis/res/img/look.svg'/></div>");
/*
                legend.append("<div class='icon tibibi' onclick='socialis.open.course(\""+_user.id+"\");' "+
                                "ontouchstart='socialis.open.course(\""+_user.id+"\");event.preventDefault();'>"+
                                "<img src='mods/socialis/res/img/courses.svg'/></div>");
*/
            }
            ret.append(legend);
            return ret;
        },
        search: function() {
            var name = $("#friend #view #input input").val();
            var pod = $("#friend #view #input select").attr("disabled")?"":$("#friend #view #input select").val();
            $("#friend #results").html("");
            if (name && name.length) {
                socialis.getJSON(pod+"mods/socialis/api/user.php",{value:name}, 0,function(_data){
                    for (var i in _data.users) {
                        $("#friend #results").append(socialis.friend.elt(_data.users[i], (_data.users.length<20), "add"));
                    }
                    if (_data.users && _data.users.length) {
                        $("#friend .popup").hide();
                        $("#friend #results").show();
                    }
                });
            }
        }
    },
    login   : function() {
        if ($("#logpanel").hasClass("s")) {
            $.getJSON("api/mods/usernew.php"+
                "?username="+$("input[name=username]").val()+"&password="+$("input[name=password]").val()+"&confirm="+$("input[name=password2]").val(),socialis.onlogin);
        }
        else {
            $.getJSON("api/mods/login.php"+
                "?username="+$("input[name=username]").val()+"&password="+$("input[name=password]").val(),socialis.onlogin);
        }
    },
    logout : function() {
        if (socialis.settings.logout) {
            clearTimeout(socialis.settings.logout); socialis.settings.logout=0;
            $.getJSON("api/mods/login.php?username="+socialis.settings.user.name, function(_data) {
                $.cookie("jlodb-code", null); location.reload();
            });
        }
        else {
            socialis.settings.logout = setTimeout(function() { socialis.settings.logout=0; }, 500);
        }
    },
    onlogin  : function(_data) {
        if (_data.status=="success"&& _data.code && _data.code.length) {
            $("#logpanel").hide();
            socialis.settings.user = _data;
            $.cookie("jlodb-name", _data.name, { expires : 1 });
            $.cookie("jlodb-code", _data.code, { expires : 1 });

            if (_data.theme) { $("#main").attr("class",_data.theme); }

            $.getJSON("mods/genius/api/state.php",function(data){
                $("#genius #board").genius('states',{nodes:data.nodes});

                socialis.getJSON("mods/socialis/api/genius.php", "", 0, function(_genius) {
                    if (_genius.genius.length) { $("#genius #board").genius('states',{nodes:_genius.genius}); }
                });
            });
            $("#user h1").html(socialis.settings.user.name);
            if ($("#user #avatar .gonz").children().length==0) {
                $("#user #avatar .gonz").gonz({interactive:false, code:socialis.settings.user.avatar, context:{
                    onclick:function($this){  },
                    onquit:function($this, _ret){}}});
            } else { $("#user #avatar .gonz").gonz('import',socialis.settings.user.avatar); }

            $("#genius #boardfooter>div").addClass("s");

            socialis.awards.build(function() {
                socialis.getJSON("mods/socialis/api/award.php", {action:"upd", node:"0"}, "", function(_data) {
                    if (_data.status=="success") {
                        socialis.awards.pinuser(_data.pin);
                        socialis.awards.unreadbadges(_data.unreadbadges,false);
                        $("#user #stars").html(_data.stars);
                    }
                });
            });
            socialis.cyclic.process();
        }
        else {
            $.cookie("jlodb-code", null);
            if ($("#logpanel").is(":visible")) {
                $("#logpanel").show().addClass("wrong");
                setTimeout(function(){$("#logpanel").removeClass("wrong");}, 800);
            }
            else { $("#logpanel").show(); }
        }
    },
    user    : {
        open : function() {
            if ($("#edit #avatar>div").children().length==0) {
                $("#edit #avatar>div").gonz({interactive:false, code:socialis.settings.user.avatar, context:{
                        onclick:function($this){ socialis.open.avatar(); },
                        onquit:function($this, _ret){}}});
            }
            else if (socialis.settings.user.avatar) {
                $("#edit #avatar>div").gonz('import',socialis.settings.user.avatar);
            }

            socialis.settings.avatar = socialis.settings.user.avatar;

            $("#upid").attr("value",socialis.settings.user.name);

            if (socialis.settings.user.last)  { $("#upln").attr("value", socialis.settings.user.last).removeClass(); }
            else                     { $("#upln").attr("value", socialis.locale.value.upln).addClass("empty"); }

            if (socialis.settings.user.first) { $("#upfn").attr("value", socialis.settings.user.first).removeClass(); }
            else                     { $("#upfn").attr("value", socialis.locale.value.upfn).addClass("empty"); }

            if (socialis.settings.user.email) { $("#upem").attr("value", socialis.settings.user.email).removeClass(); }
            else                     { $("#upem").attr("value", socialis.locale.value.upem).addClass("empty"); }

            if (socialis.settings.user.theme)  { $("#edit #theme").attr("value", socialis.settings.user.theme); }

            $("#upop").show();$("#upopr").attr("value","").hide();
            $("#upnp").show();$("#upnpr").attr("value","").hide();
            $("#upcp").show();$("#upcpr").attr("value","").hide();
            $("#edit #error").html("");
            $("#edit>div").css("top","25em").css("opacity",0).animate({top:"2em",opacity:1}, 1000 );
            $("#edit").show();

        },
        update: function() {
            var args="";
            var error="";
            if (!$("#upln").hasClass("empty") && $("#upln").attr("value")!=socialis.settings.user.last) {
                args+="&last="+$("#upln").attr("value");
            }
            if (!$("#upfn").hasClass("empty") && $("#upfn").attr("value")!=socialis.settings.user.first) {
                args+="&first="+$("#upfn").attr("value");
            }
            if (!$("#upem").hasClass("empty") && $("#upem").attr("value")!=socialis.settings.user.email) {
                if ( $("#upem").attr("value").indexOf("@")==-1 ) {
                    error = socialis.locale.email?socialis.locale.email:"Invalid e-mail";
                }
                else {
                    args+="&email="+$("#upem").attr("value");
                }
            }

            if ($("#upopr").attr("value").length) { args+="&old="+$("#upopr").attr("value"); }
            if ($("#upnpr").attr("value").length) { args+="&new="+$("#upnpr").attr("value"); }
            if ($("#upcpr").attr("value").length) { args+="&con="+$("#upcpr").attr("value"); }

            args+="&theme="+$("#edit #theme").attr("value");

            if (socialis.settings.avatar.length && socialis.settings.avatar!=socialis.settings.user.avatar) {
                args+="&avatar="+encodeURIComponent(socialis.settings.avatar);
            }

            $("#edit #error").html(error);
            if (!error.length) {
                if (args.length) {
                    socialis.getJSON("api/mods/userupd.php", args, 0, function (_data) {
                        if (_data.status=="success") { $("#edit").hide(); socialis.onlogin(_data);
                        }
                        else {
                            $("#edit #error").html(socialis.locale["err"+_data.error]?socialis.locale["err"+_data.error]:_data.textStatus);
                        }
                    });
                }
                else { socialis.user.close(); }
            }
        },
        close: function() {
            $("#edit>div").animate({opacity:0}, 500, function() {$("#edit").hide();} );
        }
    },
    tibibi : {
        settings: {
            name: "",
            group: false,
            course: 0
        },
        menu: function(_course, _name) {
            socialis.tibibi.settings.course = _course;
            $("#board #node #abstract").html("");
            $("#board #node h1").html(_name).removeClass().addClass("blue node");
            socialis.getJSON("mods/socialis/api/tibibi.php", { action:"details", value:_course}, {}, function(_data) {
                $("#board #node #menu").menu({
                    list    : _data.value.split(","),
                    state   : _data.description?_data.description:".",
                    onupdate: function($this, _state, _lastId) {
                        socialis.getJSON("mods/socialis/api/tibibi.php",
                            { action:"upd", value:socialis.tibibi.settings.course, state:_state},{},
                            function(_data) { });
                    },
                    onclick : function($this, _args) {
                        $("#waiting").show().find("div").addClass("running");
                        $("#launcher").jlodb({
                            onstart:    function($this) {
                                $("#waiting").hide().find("div").removeClass("running");
                                setTimeout(function(){ if ($("#launcher").is(":visible")) { $("#genius").hide(); } },2000);
                            },
                            onfinish:   function($this) { $("#genius").show(); $("#score").removeClass().hide(); },
                            onscore:    function($this, _ret) {
                                $("#score #newreward").hide();
                                var isnext = false;
                                if (_ret.score>=2) { isnext = $("#board #node #menu").menu('score', _ret.score).menu('more'); }
                                $("#score #next").toggle(isnext);
                                $("#score").attr("class","s"+_ret.score).show();
                                return true; } },_args);
                    }
                });
            });
            $("#board #node").show();
        },
        toggle: function(_recv) {
            if (_recv) {
                $("#tibibi .icon#r").addClass("s");
                $("#tibibi .icon#s").removeClass("s");
                $("#tibibi #recv").show();
                $("#tibibi #send").hide();
            }
            else {
                $("#tibibi .icon#r").removeClass("s");
                $("#tibibi .icon#s").addClass("s");
                $("#tibibi #recv").hide();
                $("#tibibi #send").show();
            }
        },
        send: function() {
            $("#friend #course").hide();
            var course = $("#friend #course select").val();
            if (course) {
                socialis.getJSON("mods/socialis/api/tibibi.php",
                    { action:"send", course:course, value: socialis.tibibi.settings.name, group: socialis.tibibi.settings.group?1:0},
                    { label: $("#friend #course textarea").val() },
                    function (_data) {
                    });
            }
        },
        del: {
            timer:0,
            process: function(_elt, _send_id) {
                if (socialis.tibibi.del.timer==0) {
                    $(_elt).addClass("s");
                    socialis.tibibi.del.timer = setTimeout(function(){ $(_elt).removeClass("s"); socialis.tibibi.del.timer = 0; }, 800);
                }
                else {
                    clearTimeout(socialis.tibibi.del.timer); socialis.tibibi.del.timer = 0;

                    socialis.getJSON("mods/socialis/api/tibibi.php", {action:"del",value:_send_id}, 0, function(_data) {
                        $(_elt).closest(".course").detach();
                    });
                }
            }
        },
        details: {
            timer:0,
            show: function(_send_id) {
                socialis.getJSON("mods/socialis/api/tibibi.php", {action:"data",value:_send_id}, {}, function(_data) {
                    socialis.tibibi.details.timer = 0;
                    $("#tibibi #details>div").html("<table>");
                    for (var i in _data.courses) {
                        state = "";
                        for (var j=0; j<_data.courses[i].done; j++) {
                            var val = String.fromCharCode(70-parseInt(_data.courses[i].state[j]));
                            state+="<span class='l"+val+"'>"+val+"</span>";
                        }

                        var html=   "<tr"+(_data.courses[i].done==_data.courses[i].nb?" class='done'":"")+">"+
                                        "<td><div class='id'>"+_data.courses[i].id+"</div></td>"+
                                        "<td><div class='last'>"+_data.courses[i].last+"</div></td>"+
                                        "<td><div class='first'>"+_data.courses[i].first+"</div></td>"+
                                        "<td><div class='done'>"+_data.courses[i].done+"</div></td>"+
                                        "<td><div class='nb'>"+_data.courses[i].nb+"</div></td>"+
                                        "<td><div class='state'>"+state+"</div></td>"+
                                    "</tr>";
                        $("#tibibi #details>div").append(html);
                    }
                    $("#tibibi #details>div").append("</table>");
                    $("#tibibi #details").show();
                    if (socialis.tibibi.details.timer==0) {
                        socialis.tibibi.details.timer = setTimeout(function() { socialis.tibibi.details.show(_send_id); }, 10000);
                    }
                });
            },
            hide: function() {
                if (socialis.tibibi.details.timer!=0) {
                    clearTimeout(socialis.tibibi.details.timer);
                    socialis.tibibi.details.timer=0;
                }
                $("#tibibi #details").hide();
            }
        }
    },
    open    : {
        tibibi: function() {
            socialis.getJSON("mods/socialis/api/tibibi.php", {}, {}, function(_data) {
                $("#tibibi #send").html("");
                for (var i in _data.send) {
                    var html="<div class='course'>"+
                                "<div class='h1'>"+
                                    (_data.send[i].group?"<div class='state'>"+_data.send[i].group:"<div class='state none'>")+"</div>"+
                                    "<div class='value'>"+_data.send[i].name+"</div>"+
                                    "<div class='icon' id='del' onclick='socialis.tibibi.del.process(this,\""+_data.send[i].id+"\");' ontouchstart='socialis.tibibi.del.process(this,\""+_data.send[i].id+"\");event.preventDefault();'>"+
                                        "<img src='mods/socialis/res/img/cancel.svg'/></div>"+
                                "</div>"+
                                "<div class='avatar'></div>"+
                                "<div class='legend'>"+_data.send[i].label+"</div>"+
                                "<div class='icon action' onclick='socialis.tibibi.details.show(\""+_data.send[i].id+"\");'>"+
                                    "<img src='mods/socialis/res/img/look.svg'/></div>"+
                             "</div>";
                    $("#tibibi #send").append(html);
                }

                $("#tibibi #recv").html("");
                for (var i in _data.recv) {
                    var html="<div class='course'  id='"+_data.recv[i].id+"'>"+
                                "<div class='h1'>"+
                                    "<div class='state'>"+_data.recv[i].status[0]+"/"+_data.recv[i].status[1]+"</div>"+
                                    "<div class='value'>"+_data.recv[i].name+"</div>"+
                                "</div>"+
                                "<div class='avatar' id='avatar"+i+"'><div></div></div>"+
                                "<div class='legend'>"+_data.recv[i].label+"</div>"+
                                "<div class='icon action' onclick='socialis.tibibi.menu(\""+_data.recv[i].id+"\",\""+_data.recv[i].name+"\");' ontouchstart='socialis.tibibi.menu(\""+_data.recv[i].id+"\",\""+_data.recv[i].name+"\");event.preventDefault();'><img src='mods/socialis/res/img/run.svg'/></div>"+
                             "</div>";
                    $("#tibibi #recv").append(html);
                }
                for (var i in _data.recv) {
                    $("#tibibi #recv #avatar"+i+">div").gonz({interactive:false, code:_data.recv[i].avatar,
                                                       context:{onclick:function($this){},onquit:function($this, _ret){}}});
                }
            });
            $("#main>#tibibi").show();
        },
        course: function(_name) {
                if (_name) {
                    socialis.tibibi.settings.name = _name;
                    socialis.tibibi.settings.group= false;
                }
                else {
                    socialis.tibibi.settings.name = socialis.friend.group.settings.name;
                    socialis.tibibi.settings.group= true;
                }
                $("#friend #course .h1").html(socialis.tibibi.settings.name);
                $("#friend #course textarea").val("");

                socialis.getJSON("mods/socialis/api/tibibi.php", { action:"courses"}, 0, function (_data) {
                    $("#friend #course select").html("");
                    for (var i in _data.courses) {
                        $("#friend #course select").append("<option value='"+_data.courses[i]+"'>"+_data.courses[i]+"</option>");
                    }
                });

                $("#friend #course").show();
        },
        avatar : function() {
            if ($("#edit #gonz").children().length==0) {
                $("#edit #gonz").gonz({class:"nosnapshot", code:socialis.settings.avatar,
                    context:{onquit:function($this, _ret){
                        $("#edit #header").show(); $("#edit #footer").show(); $this.hide();
                        socialis.settings.avatar = _ret.code;
                        $("#edit #avatar>div").gonz('import',socialis.settings.avatar);
                }}});
            } else if (socialis.settings.user.avatar) { $("#edit #gonz").gonz('import',socialis.settings.avatar); }

            $("#edit #header").hide(); $("#edit #footer").hide(); $("#edit #gonz").show();
        }
    }
};

window.onload = function() {
    // SPECIAL STUFF
    document.ontouchmove = function(e) { e.preventDefault(); }

    $.getJSON("api/checkdb.php", function (_check) {
      if (_check.status=="success") {
        $.getJSON("mods/genius/api/checkdb.php", function(_checkGenius) {
         if (_checkGenius.status=="success") {
         $.getJSON("mods/socialis/api/checkdb.php", function(_checkSocialis) {
           if (_checkSocialis.status=="success") {

            socialis.settings.lang=_check.lang;

            $.getJSON("mods/socialis/locale/"+socialis.settings.lang+"/text.json?id="+Math.floor(Math.random()*1000), function(_locale) {
                socialis.locale = _locale;
                for (var i in _locale.html)     { $("#"+i).html(_locale.html[i]); }
                for (var i in _locale.value)    { $("#"+i).attr("value", _locale.value[i]); }
            });

            $("#friend #view select").attr("disabled","disabled");
            $.getJSON("mods/socialis/conf/pods.json", function(_pods) {
                for (var p in _pods) {
                    $("#friend #view select").append("<option value='"+_pods[p]+"'>"+p+"</option>");
                }
                if (_pods.length) { $("#friend #view select").removeAttr("disabled"); }
            });

            // GET AND RESIZE THE BEST PANEL
            var x = Math.floor($(window).width()/16);
            var y = Math.floor($(window).height()/12);
            $("body").css("font-size", (Math.min(x,y))+"px");
            $("#main").css("margin-top", Math.floor(($(window).height()-$("#main").height())/2)+"px").show();

            // DEBUG MODE
            var a = location.search.substring(1).split('&');
            $("body").toggleClass("debug",(a.length&& a[0]=="debug"));

            $("#main>#genius #board").genius({
                state: function($this, _id, _ex, _cbk) {
                    socialis.getJSON("mods/socialis/api/state.php", {node:_id}, "", function(_state) {
                        var state = _state.state;
                        if (!state.length) { state = "."; }
                        _cbk($this, _ex, state);
                    });
                },
                onnode: function($this, _id, _available) {
                    if (_available) { $("#waiting").show().find("div").addClass("running"); }
                    else            { socialis.example.open($this, _id, true); }

                    return true; },
                onshow: function($this) { $("#waiting").hide().find("div").removeClass("running"); },
                onbuild: function($this) {
                    // LOG PANEL
                    if ($.cookie("jlodb-name") && $.cookie("jlodb-code") && $.cookie("jlodb-code")!=0) {
                        $.getJSON("api/mods/login.php?username="+$.cookie("jlodb-name")+"&code="+$.cookie("jlodb-code"),socialis.onlogin);
                    }
                    else { $("#logpanel").show(); }
                },
                onclick: function($this, $menu, _args) {
                    $("#launcher").jlodb({
                        onstart:    function($this) {
                            setTimeout(function(){ if ($("#launcher").is(":visible")) { $("#genius").hide(); } },2000);
                        },
                        onfinish:   function($this) { $("#genius").show(); $("#score").removeClass().hide(); },
                        onscore:    function($this, _ret) {
                            var isnext = false;
                            if (_ret.score>=2) {
                                isnext = $menu.menu('score', _ret.score).menu('more');
                                socialis.finished = !isnext;
                                $("#score #reload").toggle(isnext);
                            }
                            $("#score #next").toggle(isnext);
                            socialis.score.effect(_ret.score);
                            $("#score").attr("class","s"+_ret.score).show();
                            return true; },
                        onexercice: function($this,_id,_a){
                            $("body").toggleClass("nosplash",(_a==socialis.activity)); socialis.activity=_a; }
                        },_args);

                },
                onupdate: function($this, $menu, _id, _state, _lastId) {
                    $("#score #newreward").hide();
                    socialis.getJSON("mods/socialis/api/state.php","node="+_id, { state: _state} , function(_state) {
                        socialis.getJSON("mods/socialis/api/award.php", {action:"upd", node:"0"}, "", function(_data) {
                            if (_data.status=="success") {
                                $("#user #stars").html(_data.stars);
                                if (_data.nbnew) {
                                    socialis.awards.unreadbadges(_data.unreadbadges,true);
                                    $("#score #newreward").show();
                                }
                            }
                         });
                    });
                },
                onstate: function($this, _nodes) {
                    $("#newreward").hide();
                    var regLabel = new RegExp("\\\[1\\\]","g");
                    var label = socialis.locale.complete.replace(regLabel,"[<b>"+$("#board #node #header h1").text()+"</b>]");
                    $("#finish #label>div").html(label).removeClass("s");
                    socialis.getJSON("mods/socialis/api/genius.php", "", {genius:_nodes}, function(_genius) {
                        socialis.getJSON("mods/socialis/api/award.php", {action:"upd", node:"1"}, "", function(_data) {
                            $("#finish #label>div").addClass("s");
                            if (_data.status=="success") {
                                $("#user #stars").html(_data.stars);
                                if (_data.nbnew) {
                                    socialis.awards.unreadbadges(_data.unreadbadges,true);
                                    $("#finish #newreward").show();
                                }
                            }
                        });
                    });
                },
                onclosenode: function($this) {
                    if (socialis.tibibi.settings.course) {
                        var state = $("#board #node #menu").menu('state');
                        var i=0; for (i=0; i<state.length; i++) { if (state[i]=='.' || state[i]=='l') break; }
                        var $elt = $(".course#"+socialis.tibibi.settings.course+" .state");
                        $(".course#"+socialis.tibibi.settings.course+" .state").html(i+$elt.html().substr($elt.html().indexOf('/')));
                } }
            });
          }});
         }});
        }
        else {
            $("#checkKO #message").html("Error #"+_check.error+": "+_check.textStatus);
            $("#checkKO").show();
        }
    });

}



    </script>
</head>

<body>
    <div id="checkKO"><div id="message"></div></div>
    <div id="main">
        <div id="genius">

            <div id="boardmask" class="mask">
                <div>
                    <div id="quit" ontouchstart="socialis.example.close(true);event.preventDefault();"
                                   onclick="socialis.example.close(true);"><img src="res/img/icon/quit.svg"/></div>
                    <h1></h1>
                    <div id="example" ontouchstart="socialis.example.launch();event.preventDefault();"
                                      onclick="socialis.example.launch();"><div id="legend"></div></div>
                    <div id="source"></div>
                </div>
            </div>

            <div id="board"></div>
            <div id="boardfooter"><div id="footertext"></div></div>


            <!-- USER PANEL (BOTTOM-RIGHT): NAME,STARS,AVATAR AND MENU -->
            <div id="user">
                <div id="avatar" class="avatar" onclick="socialis.user.open();"
                                 ontouchstart="socialis.user.open();event.preventDefault();">
                    <div class="gonz"></div>
                    <div class="badge"></div>
                </div>
                <div id="details">
                    <h1 onclick="socialis.user.open();" ontouchstart="socialis.user.open();event.preventDefault();"></h1>
                    <div class="stars">
                        <div class="icon"><img src="mods/socialis/res/img/star.svg"/></div>
                        <div id="stars">0</div>
                    </div>
                    <div id="buttons">
                        <div class="icon" onclick="socialis.news.open();" ontouchstart="socialis.news.open();event.preventDefault();">
                            <img src="mods/socialis/res/img/list.svg"/>
                        </div>
                        <div class="icon" onclick="socialis.awards.open();" ontouchstart="socialis.awards.open();event.preventDefault();">
                            <img src="mods/socialis/res/img/award.svg"/>
                            <div class="l" id="success"></div>
                        </div>

                        <div class="icon" onclick="socialis.friend.open();" ontouchstart="socialis.open.friend();event.preventDefault();">
                            <img src="mods/socialis/res/img/people.svg"/>
                            <div class="l" id="ask"></div>
                        </div>
<!--
                        <div class="icon" id="courses" onclick="socialis.open.tibibi();"
                                                       ontouchstart="socialis.open.tibibi();event.preventDefault();">
                            <img src="mods/socialis/res/img/courses.svg"/>
                            <div class="l" id="new"></div>
                        </div>
-->
                        <div class="icon" onclick="socialis.logout();" ontouchstart="socialis.logout();event.preventDefault();">
                            <img src="mods/socialis/res/img/logout.svg"/>
                        </div>
                    </div>
                </div>
            </div>

            <div id="waiting" class="anim12"><div><img src="res/img/generic/waiting.svg"/></div></div>
        </div>

        <!-- EXERCICE PANEL -->
        <div id="launcher">
            <div id="quit" ontouchstart="socialis.activity='';$('#launcher').jlodb('quit');event.preventDefault();"
                           onclick="socialis.activity='';$('#launcher').jlodb('quit');">
                <img src="res/img/icon/back.svg"/>
            </div>
            <div id="activity"></div>
        </div>

        <!-- SCORE -->
        <div id="score"><div>
            <div class="content">
                <div class="value"></div><div class="stars"></div>
                <div class="icon" id="reload" ontouchstart="$('#launcher').jlodb('reload');event.preventDefault();"
                    onclick="$('#launcher').jlodb('reload');" ><img src="res/img/icon/reload.svg"/></div>
                <div class="icon" id="menu" ontouchstart="socialis.menu();$('#launcher').jlodb('close',true);event.preventDefault();"
                    onclick="socialis.menu();$('#launcher').jlodb('close',true);" ><img src="res/img/icon/menu.svg"/></div>
                <div class="icon" id="next" ontouchstart="$('#launcher').jlodb('close', false);$('#menu').menu('next');event.preventDefault();"
                    onclick="$('#launcher').jlodb('close', false);$('#menu').menu('next');"><img src="res/img/icon/next.svg"/></div>
            </div>
            <div id="newreward" class="icon"><img src="mods/socialis/res/img/reward.svg"/></div>
            <div id="touch01" class="splash01"><div><img src="res/img/effects/touch01.svg"/></div></div>
            <div id="touch01" class="splash02"><div><img src="res/img/effects/touch01.svg"/></div></div>
        </div></div>

        <!-- AWARD PANEL -->
        <div id="awards" class="mask"><div>
          <div id="header">
            <div id="quit" ontouchstart="socialis.awards.close();event.preventDefault();"
                           onclick="socialis.awards.close();"><img src="res/img/icon/quit.svg"/></div>
            <div id="awardstitle"></div>
          </div>
          <div id="content">
            <div id="menu"></div>
            <div id="detail">
                <div id="thumbnails"></div>
                <div id="text" ontouchstart="socialis.awards.pin();event.preventDefault();"
                               onclick="socialis.awards.pin();"></div>
            </div>
          </div>
        </div></div>

        <!-- NEWS PANEL -->
        <div id="news" class="mask"><div>
          <div id="header">
            <div id="quit" ontouchstart="socialis.news.close();event.preventDefault();"
                               onclick="socialis.news.close();"><img src="res/img/icon/quit.svg"/></div>
            <div id="newstitle"></div>
          </div>
          <div id="content"></div>
        </div></div>

        <!-- LOGIN PANEL -->
        <div id="logpanel">
            <div><div>
                <div class="param" id="ll">
                    <div class="label" id="loclog"></div><div class="input"><input type="text" name="username"/></div>
                    <div class="icon" onclick="$('#logpanel').toggleClass('s');"
                                      ontouchstart="$('#logpanel').toggleClass('s');event.preventDefault();">
                        <img src="mods/tibibi/res/img/new.svg"/></div>
                </div>
                <div class="param">
                    <div class="label" id="locpwd"></div><div><input type="password" name="password"/></div>
                </div>
                <div class="param" id="lp">
                    <div class="label" id="locconf"></div><div><input type="password" name="password2"/></div>
                </div>
                <div class="button" id="logvalid" onclick="socialis.login();"
                                                  ontouchstart="socialis.login();event.preventDefault();">Valid</div>
            </div></div>
        </div>


        <!-- EDIT PANEL -->
        <div id="edit" class="mask"><div>
          <div id="header">
            <div id="avatar"><div></div></div>
            <div id="settings">
                <input value="id" id="upid" disabled="disabled"/>
                <input value="last name" id="upln" onfocus="if ($(this).hasClass('empty')) { $(this).removeClass().attr('value',''); }"/>
                <input value="first name" id="upfn" onfocus="if ($(this).hasClass('empty')) { $(this).removeClass().attr('value',''); }"/>
                <input value="email" id="upem" onfocus="if ($(this).hasClass('empty')) { $(this).removeClass().attr('value',''); }"/>
                <input value="old password" id="upop" class="empty" onfocus="$(this).hide();$('#upopr').show().focus();" />
                <input value="" type="password" id="upopr" style="display:none;"/>
                <input value="new password" id="upnp" class="empty" onfocus="$(this).hide();$('#upnpr').show().focus();" />
                <input value="" type="password" id="upnpr" style="display:none;"/>
                <input value="confirmation" id="upcp" class="empty" onfocus="$(this).hide();$('#upcpr').show().focus();" />
                <input value="" type="password" id="upcpr" style="display:none;"/>
            </div>
            <div id="misc">
                <div><div class="label" id="themelabel"></div>
                     <select id="theme"><option id="theme1" value="theme1"></option><option id="theme2" value="theme2"></option></select></div>
            </div>
            <div id="error"></div>
          </div>
          <div id="footer">
                <div class="icon" id="cancel" onclick="socialis.user.close();" 
                                              ontouchstart="socialis.user.close();event.preventDefault();">
                    <img src="mods/socialis/res/img/cancel.svg"/>
                </div>
                <div class="icon" id="valid" onclick="socialis.user.update();" 
                                             ontouchstart="socialis.user.update();event.preventDefault();">
                    <img src="mods/socialis/res/img/valid.svg"/>
                </div>
          </div>
          <div id="gonz"></div>
        </div></div>


        <div id="friend" class="mask"><div>

            <div id="menu">
                <div id="quit" ontouchstart="socialis.friend.close();event.preventDefault();"
                               onclick="socialis.friend.close();"><img src="res/img/icon/quit.svg"/></div>
                <div id="group"></div>
                <div id="footer">
                    <div class="icon" id="addgroup"
                        onclick="$('#popup input').val('');$('#popup .icon').hide();$('#popup #new').show();$('#popup').show();"
                        ontouchstart="$('#popup input').val('');$('#popup .icon').hide();$('#popup #new').show();$('#popup').show();event.preventDefault();">
                        <img src="mods/socialis/res/img/add.svg"/>
                    </div>
                    <div class="icon" id="delgroup"
                        onclick="socialis.friend.group.del(this);"
                        ontouchstart="socialis.friend.group.del(this);event.preventDefault();">
                        <img src="mods/socialis/res/img/cancel.svg"/>
                    </div>
                    <div class="icon"
                        onclick="$('#popup input').val($('#friend #group .e.s').html());$('#popup .icon').hide();$('#popup #edit').show();$('#popup').show();"
                        ontouchstart="$('#popup input').val($('#friend #group .e.s').html());$('#popup .icon').hide();$('#popup #edit').show();$('#popup').show();event.preventDefault();">
                        <img src="mods/socialis/res/img/edit.svg"/>
                    </div>
                    <div class="icon"
                        onclick="socialis.friend.group.move(true);"
                        ontouchstart="socialis.friend.group.move(true);event.preventDefault();">
                        <img src="mods/socialis/res/img/up.svg"/>
                    </div>
                    <div class="icon"
                        onclick="socialis.friend.group.move(false);"
                        ontouchstart="socialis.friend.group.move(false);event.preventDefault();">
                        <img src="mods/socialis/res/img/down.svg"/>
                    </div>
<!--
                    <div class="icon tibibi"
                        onclick="socialis.open.course();"
                        ontouchstart="socialis.open.course();event.preventDefault();">
                        <img src="mods/socialis/res/img/courses.svg"/>
                    </div>
-->
                </div>
            </div>

            <div id="view">
                <div id="input">
                    <div class="icon" id="search" onclick="socialis.friend.search();"
                                      ontouchstart="socialis.friend.search();event.preventDefault();">
                        <img src="mods/socialis/res/img/look.svg"/>
                    </div>
                    <input type="text"/>
                    <select></select>
                    <div class="filler"></div>
                    <div class="icon del" onclick="$('#friend').toggleClass('del');$(this).toggleClass('s');"
                                      ontouchstart="$('#friend').toggleClass('del');$(this).toggleClass('s');event.preventDefault();">
                        <img src="mods/socialis/res/img/delete.svg"/>
                    </div>
                    <div id="ask" class="icon"
                             onclick="$('#friend .popup').hide();$('#friend #asks').show();"
                        ontouchstart="$('#friend .popup').hide();$('#friend #asks').show();event.preventDefault();">0</div>
                    <div class="icon"
                             onclick="$('#friend .popup').hide();" ontouchstart="$('#friend .popup').hide();event.preventDefault();">
                        <img src="mods/socialis/res/img/people.svg"/>
                    </div>
                </div>
                <div id="results" class="popup"></div>
                <div id="asks" class="popup"></div>
                <div id="list"></div>
            </div>

            <div id="genius" class="mask"><div>
                <div id="board"></div>
                <div id="quit" ontouchstart="$('#friend #genius').hide();$('#friend #genius #board').html('');event.preventDefault();"
                                onclick="$('#friend #genius').hide();$('#friend #genius #board').html('');">
                    <img src="res/img/icon/quit.svg"/>
                </div>
                <div id="avatar"></div>
            </div></div>

            <div id="course" class="mask"><div>
                <div class="h1"></div>
                <div id="select">
                    <select></select>
                    <div class="icon"
                        onclick="window.location='tibibi.html?socialis';"
                        ontouchstart="window.location='tibibi.html?socialis';event.preventDefault();">
                        <img src="mods/socialis/res/img/add.svg"/>
                    </div>
                </div>
                <textarea spellcheck="false"></textarea>
                <div id="footer">
                    <div class="icon" id="cancel" onclick="$('#friend #course').hide();"
                                                  ontouchstart="$('#friend #course').hide();event.preventDefault();">
                        <img src="mods/socialis/res/img/cancel.svg"/>
                    </div>
                    <div class="icon" id="valid" onclick="socialis.tibibi.send();"
                                                 ontouchstart="socialis.tibibi.send();event.preventDefault();">
                        <img src="mods/socialis/res/img/valid.svg"/>
                    </div>
                </div>
            </div></div>

            <div id="popup" class="mask" onclick="$(this).hide();" ontouchstart="$(this).hide();event.preventDefault();"><div>
                <div>
                    <input type="text" onclick="event.stopPropagation();" ontouchstart="event.stopPropagation();">
                    </input>
                    <div id="new" class="icon"
                        onclick="socialis.friend.group.add($('#popup input').val());$('#popup').hide();event.stopPropagation();"
                        ontouchstart="socialis.friend.group.add($('#popup input').val());$('#popup').hide();event.stopPropagation();event.preventDefault();">
                        <img src="mods/socialis/res/img/add.svg"/>
                    </div>
                    <div id="edit" class="icon"
                        onclick="socialis.friend.group.edit($('#popup input').val());$('#popup').hide();event.stopPropagation();"
                        ontouchstart="socialis.friend.group.edit($('#popup input').val());$('#popup').hide();event.stopPropagation();event.preventDefault();">
                        <img src="mods/socialis/res/img/edit.svg"/>
                    </div>
                </div>
            </div></div>

        </div></div>


        <div id="tibibi" class="mask"><div>
            <div id="header">
                <div id="menu">
                    <div id="toggle">
                        <div class="icon s" id="r" onclick="socialis.tibibi.toggle(true);"
                                ontouchstart="socialis.tibibi.toggle(true);event.preventDefault();">
                            <img src="mods/socialis/res/img/import.svg"/>
                        </div>
                        <div class="icon" id="s" onclick="socialis.tibibi.toggle(false);"
                                ontouchstart="socialis.tibibi.toggle(false);event.preventDefault();">
                            <img src="mods/socialis/res/img/export.svg"/>
                        </div>
                    </div>
                    <div class="filler"></div>
                    <div class="icon del" onclick="$('#tibibi').toggleClass('del');$(this).toggleClass('s');"
                                      ontouchstart="$('#tibibi').toggleClass('del');$(this).toggleClass('s');event.preventDefault();">
                        <img src="mods/socialis/res/img/delete.svg"/>
                    </div>
                </div>
                <div id="quit" ontouchstart="socialis.tibibi.settings.course=0;$('#tibibi').hide();event.preventDefault();"
                               onclick="socialis.tibibi.settings.course=0;$('#tibibi').hide();"><img src="res/img/icon/quit.svg"/></div>
            </div>
            <div id="send"></div>
            <div id="recv"></div>

            <div id="details" class="mask" onclick="socialis.tibibi.details.hide();" ontouchstart="socialis.tibibi.details.hide();event.preventDefault();"><div>
            </div></div>

        </div></div>


    </div>


</body>
