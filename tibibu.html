<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>tibibu</title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="js/jquery.svg.min.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.jlodb.js"></script>
    <script type="text/javascript" src="js/jquery.jlodb.menu.js"></script>
    <script type="text/javascript" src="js/jlodb-ext.js"></script>
    <script type="text/javascript" src="user/user.js"></script>
    <script type="text/javascript" src="gonz/jquery.gonz.js"></script>
    
    <script type="text/javascript" src="activities/draw/draw.js"></script>

    <script type="text/javascript" src="mods/tibibu/slide/slide.js"></script>
    <link type="text/css" rel="stylesheet" href="mods/tibibu/slide/style.css" media="all" />

    <link type="text/css" rel="stylesheet" href="css/jlodb.css" media="all" />
    <link type="text/css" rel="stylesheet" href="user/style.css" media="all" />
    <link rel="apple-touch-icon-precomposed" href="res/img/white/icon/icon144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="res/img/white/icon/icon72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="res/img/white/icon/icon114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="res/img/white/icon/icon144.png" />
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <style>
.user .icon.mail                        { cursor:pointer; font-size:1.5em; margin-top:0.1em; clear:both; }

#bumain                                 { position:relative; background-image:url('res/img/background/book02.svg'); }
#bumain>div                             { width:16.5em; height:12em; }
#bunav                                  { font-size:.3em; width:10em; height:100%; border:1px solid black; border-width:0 2px 0 0; background-color:rgba(255,255,255,0.6); float:left; }
.bucontent                              { float:left; font-size:0.5em; display:none; height:24em; width:26em; }
.bunav2                                 { font-size:.8em; display:none; }
.bunav2>div                             { padding-left:1em; background-color:gray; margin-top:.3em; color:white; cursor:pointer; }
.bunav2>div.s                           { background-color:red; }
#bumain #profile                        { background-color:#5B6; width:10em; color:white;height:3em;}
#bumain #profile>*                      { float:left; }
#bumain #profile #avatar                { width:1em; height:1em; background-color:#444; font-size:3em; cursor:pointer; }
#bumain #profile #label                 { margin-left:.2em;  font-size:.7em; width:5.2em; }
#bumain #profile #sub                   { font-size:.8em; color:yellow; }
#bumain #profile #edmode                { font-size:2em; opacity:0.3; }
#bumain.devmode #profile #edmode        { opacity:1; }
#bumain #profile .icon                  { font-size:3em; cursor:pointer; }
#bumain #profile #gdx                   { display:none; }
#bumain #profile #gdx.s                 { background-color:red; border-radius:.5em; }
#bumain #upuser>div                     { left:1em; }
#bumain #umenu                          { display:none; height:35em;}
#bumain #butarget                       { font-size:.6em; background-color:black; color:white; padding:.8em 0 1em .5em;}
#bumain .bu.bluekeypad                  { margin-top:.5em; color:white; padding-left:.5em; cursor:pointer; }
#bumain .bu.bluekeypad>div              { float:left; }
#bumain .bu.bluekeypad .alert           { float:right; min-width:1.5em; background-color:rgba(255,0,0,0.6); border-radius:.2em; margin:0.2em; text-align:center; font-weight:bold; font-size:0.8em; }
#bumain .usermode                       { display:inherit; }
#bumain .devmode                        { display:none; }
#bumain.devmode .usermode               { display:none; }
#bumain.devmode .devmode                { display:inherit; }
#bumain #waiting                        { position:absolute; top:3.1em; left:0.05em; font-size:2.7em; }
#bumain #outputpanel textarea           { font-size:0.4em; border:0; width:47em; height:10em; overflow:auto; }
#butoggle                               { height:12em; }

#buslide #busoverview                   { background-color:black; padding:.5em; }
#buslide #busoverview>div               { background-color:white; width:16em; height:12em; font-size:1.2em; margin:0 auto; }
#buslide #buscontent                    { padding-left:1em; font-size:0.4em; background-color:gray; color:white;  }
#buslide #busvalues                     { overflow:auto; height:8.2em; }
#buslide #buscontent span               { cursor:pointer; }
#buslide #buscontent span.s             { background-color:red; }
#buslide #busbutton                     { float:right; font-size:2.5em; margin:.1em .2em 0 0;}
#buslide #buslist                       { overflow:auto; font-size:0.5em; float:left; height:8em; width:8em; margin:3px .2em .2em .2em; border:1px solid black; }
#buslide #buslist>div                   { padding-left:.2em; cursor:pointer; background-color:white; }
#buslide #buslist>div.s                 { background-color:#DDD; }
#buslide textarea                       { float:left; margin-top:3px; font-size:.5em; border:1px solid black; width:40em; height:8em; }
#buslide #busaction                     { float:right; padding:0 .1em; background-color:#444; height:4.4em; }
#buslide .bu.icon                       { cursor:pointer; }
#buslide .bu.icon.s                     { background-color:red; }

.bupmenu                                { border:1px solid black; border-width:0 2px 0 0; float:left; font-size:.5em; width:17em; height:100%; }
#buprep #buplist                        { height:6em; overflow:auto; border:1px solid black; border-width:0 0 2px 0; }
#buprep #buplist>div                    { padding-left:.5em; cursor:pointer; background-color:white; }
#buprep #buplist>div.s                  { cursor:pointer; background-color:#DDD; }
#buprep #bupvalues                      { background-color:gray; color:white; height:10em; }
#buprep #bupvalues>span                 { cursor:pointer; }
#buprep #bupvalues>span.s               { background-color:red; }
#bupmenu textarea                       { border:0; width:20.5em; height:31em; font-size:0.8em; padding:0 .2em; overflow:auto; }
#bupmenu #bupid                         { background-color:#444; color:white; text-align:center; height:1.2em; }
#bupmenu #bupid.s                       { background-color:#046; }
#bupmenu #bupbuttons                    { background-color:#444; font-size:2em; height:2.5em; }
#bupmenu #bupbuttons .icon              { cursor:pointer; margin:.1em; float:left; }
#bupmenu #bupbuttons .icon.s            { background-color:red; }
.bupcontrol                             { background-color:gray; font-size:2em; padding:.1em 0; }
.bupcontrol .icon                       { cursor:pointer; margin:.1em; float:left; }
.bupcontrol .icon.s                     { background-color:red; }
.bupcontrol #bupsave                    { opacity:0.2; cursor:auto; }
.bupcontrol #bupsave.s                  { opacity:1; cursor:pointer; background-color:inherit;}
.buprender                              { height:24em; overflow:auto; }

.buprep                                 { width:16.4em; }
.buprep>div                             { width:16em; cursor:pointer; margin-bottom:.1em; }
.buprep>div.hide2                       { display:none; }
.buprep>div.s                           { background-color:rgba(255,255,0,0.5); border:4px solid red; border-width:0 .4em 0 0; }
.buprep>div.tmp                         { background-color:rgba(0,255,0,0.2); border:4px solid #0F0; border-width:0 .4em 0 0 ; }
.buprep>div.hide3                       { display:none; }

.buprep .label                          { color:#ff8; margin-left:.5em; font-weight:bold;}
.buprep .header                         { background-color:red; color:white; padding-left:.1em; height:1.2em; }
.buprep .title                          { float:left; margin-left:.1em;  }
.buprep>.comment>div                   { font-size:.6em; font-style:italic; text-align:justify; margin-left: 2em; width:80%; }

.buprep .icon                           { float:left; font-size:.5em; margin-top:.7em; margin-right:.4em; cursor:pointer; }
.buprep .number                         { float:left; width:1.5em; padding-right:.1em; text-align:right; margin-right:.2em; border:1px solid black; border-width:0 1px 0 0; }
.buprep textarea                        { font-size:1em; border:0; }
.buprep .obj                            { margin-top:.1em; clear:both; font-size:.5em;background-color:rgba(0,0,0,0.5); color:white; padding-bottom:.2em; }
.buprep .obj.empty                      { display:none; }
.buprep .obj .value                     { margin-left:1.5em; }
.buprep .equ                            { margin-top:.1em; clear:both; font-size:.5em;background-color:rgba(100,100,0,0.5); color:white; padding-bottom:.2em; }
.buprep .equ.empty                      { display:none; }
.buprep .equ .value                     { margin-left:1.5em; }
.buprep .attrs                          { width:16.2em; }
.buprep .attr                           { font-size:.6em; width:8.6em; background-color:rgba(100,100,0,0.5); color:white; height:2.4em; float:left; margin:.1em 0 .1em .1em; }
.buprep .attr.classification            { width:9.3em; margin-left:0;}
.buprep .attr .value                    { text-align:right; margin-right:.5em; }
.buprep .session                        { margin-top:.3em; }
.buprep .session>.header                { font-size:.8em; }
.buprep .session.closed .obj            { display:none; }
.buprep .session.closed .equ            { display:none; }
.buprep .duration                       { float:right; margin-right:.2em; width:1.5em; text-align:center; background-color:#FFF; height:1.2em; color:red;}
.buprep .step                           { margin-top:.2em; }
.buprep .step>div                       { font-size:.7em; border:1px solid red; border-width:2px 0 2px 0; color:black; padding-left:.2em; height:1.2em; }
.buprep .step .duration                 { float:right; width:1.5em; text-align:center; height:1.2em; color:white; background-color:red; }
.buprep .hint:before                    { content:"♣"; float:left; margin-right:0.2em; width:1em; text-align:center; color:#8FA;}
.buprep .hint                           { font-size:.7em; background-color:#5B6; color:white; }
.buprep .teacher:before                 { content:"♥"; float:left; margin-right:0.2em; width:1em; text-align:center; color:#FFA;}
.buprep .teacher                        { font-size:.7em; background-color:#BB6; color:white; }
.buprep .student:before                 { content:"♠"; float:left; margin-right:0.2em; width:1em; text-align:center; color:#8AF;}
.buprep .student                        { font-size:.7em; background-color:#56B; color:white; }
.buprep .generic .text                  { font-size:.5em; margin-left:2em; border:1px solid black; border-width:0 0 0 1px; padding-left:.5em; text-align:justify; }
.buprep .com                            { margin-left:2em; font-size:.7em; background-color:rgba(84, 137, 184, 0.9); color:white;}
.buprep .com .label                     { margin-left:.2em; color:#BEF;}
.buprep .com .data                      { background-color:rgba(0,0,0,0.5); font-size:.4em; padding:0 .2em; max-height:3em; }
.buprep .slides .data                   { display:none; }
.buprep .slides .description            { font-size:.5em; margin-left:2.5em; padding-left:.5em; text-align:justify; margin-bottom:.1em; }
.buprep .slides .com                    { margin-bottom:0; }
.buprep .actions                        { float: right; margin-right:.2em; margin-top:.1em;  }
.buprep .actions>div                    { width:1em; height:1em; cursor:pointer; float:right;}
.limited .buprep .com .data             { display:none; }
.limited .buprep .hint                  { display:none; }
.limited .buprep .teacher               { display:none; }
.limited .buprep .student               { display:none; }
.limited .buprep .generic .text         { display:none; }
.limited .buprep .obj                   { display:none; }
.limited .buprep .slides .description   { display:none; }

#buboard                                { height:24em; }
#buboard>#budraw                        { height:100%; position:relative; }
#buboard>#buborder                      { float:right; width:2em; height:100%; background-color:gray; }

.bupanel                               { position:absolute; top:0; background-color:white; width:16em; height:12em; display:none; }
#buslider>div                           { width:100%; height:100%; }
.buquit                                 { position:absolute; z-index:2000; width:1em; height:1em; cursor:pointer; }
#buex                                   { margin:.5em 0 0 .5em; }

#bulauncher #activity                   { position:relative; width:100%; height:100%; }

#bupresults>div                         { background-color:#56B; color:white; margin:.1em; padding-left:.2em; cursor:pointer; }
#bupresults>div .e                      { float:right; width:1em; height:1em; }
#busendpanel.d input                    { color:gray; }
#busendpanel.d textarea                 { color:gray; }

#buinbox #buiheader                     { height:10em; border:2px solid black; border-width:0 0 2px 0; background-color:white; }
#buinbox #buiheader #buimessage         { width:20em; height:10em; overflow:auto; border:2px solid black; border-width:0 2px 0 0; }
.bumsg                                  { background-color:#56B; color:white; margin:.1em; padding-left:.2em; cursor:pointer; font-size:.8em; }
.bumsg.text                             { background-color:gray; }
.bumsg.draw                             { background-color:#5B6; }
.bumsg .id                              { display:none; }
.bumsg .icon                            { float:left; margin:.1em .1em 0 0; }
.bumsg.s                                { background-color:red !important; }
#buicontent                             { padding:.25em; height:10.6em; }
#builaunch                              { background-color:gray; height:1em; font-size:3em; cursor:pointer; display:none; }
#builaunch>div                          { margin:0 auto; }

    </style>
    <script>

// USER EVENT CALLBACK (FROM user/user.js)
user.onEvent = function() {
    $("#profile #avatar").html("");
    $("#tibibi select").html("");
    $("#bumain").removeClass("devmode");

    $(".confidential").html("");
    $("textarea").val("");
    tibibu.prep.init();

    $(".bucontent").hide(); $(".bunav2").hide(); $(".bunav2>div").removeClass("s");
    $("#budraw").draw("clean");

    if (user.settings && user.settings.name) {
        $("#profile #avatar").gonz({interactive:false, code:user.settings.avatar,
                                    context:{onclick:function($this){},onquit:function($this, _ret){}}});
        $("#profile #label #name").html(user.settings.name);
        $("#profile #label #sub").html("#"+user.settings.tag);

        $("#profile>*").show();

        if (user.settings.devmode) { $("#bumain").addClass("devmode"); } else { $("#bumain").removeClass("devmode"); }
        $("#umenu").show();
        $("#buboard").show();
    }
    else {
        // CLEAN PAGE ON LOGOUT
        $("#profile>*").hide(); $("#umenu").hide();
        $("#ufscontent").html(""); $("#ufsheader input").val("");
        $("#logpanel").show();
    }


};

// TEXT FORMATING
var regExp = [
        "\\\[b\\\]([^\\\[]+)\\\[/b\\\]",            "<b>$1</b>",
        "\\\[i\\\]([^\\\[]+)\\\[/i\\\]",            "<i>$1</i>",
        "\\\[br\\\]",                               "<br/>",
        "\\\[blue\\\]([^\\\[]+)\\\[/blue\\\]",      "<span style='color:blue'>$1</span>",
        "\\\[red\\\]([^\\\[]+)\\\[/red\\\]",        "<span style='color:red'>$1</span>",
        "\\\[strong\\\](.+)\\\[/strong\\\]",        "<div class='strong'>$1</div>"
    ];

var tibibu = {
    lang            : "",
    locale          : {},
    format: function(_text) {
        for (var j=0; j<2; j++) for (var i=0; i<regExp.length/2; i++) {
            var vReg = new RegExp(regExp[i*2],"g");
            _text = _text.replace(vReg,regExp[i*2+1]);
        }
        return _text;
    },
    devmode: function() { if ($("#bumain").hasClass("devmode")) { user.devmode(); } else { $("#udevmode").show(); } },
    menu: function(_elt) {
        var id = $(_elt).attr("id");
        $(_elt).addClass("touch"); setTimeout(function() { $(_elt).removeClass("touch");}, 100);
        switch (id) {
            case "ubmenu" : $("#buboard").show(); $(".bunav2>div").removeClass("s"); $(".bunav2").hide(); break;
            default:
                var cb = { "ufmenu":"friend", "uemenu":"homework", "upmenu":"prep", "ummenu":"ummessage" };
                var isVisible = $("#"+cb[id]).is(":visible");
                $(".bunav2").hide();
                if (!isVisible)  { $("#"+cb[id]).show(); }
                break;
        }
    },
    inputpanel : {
        cbk: 0,
        open: function(_v,_c) { tibibu.inputpanel.cbk = _c; $("#inputpanel input").val(_v); $("#inputpanel").show(); },
        valid: function()     { $("#inputpanel").hide(); if (tibibu.inputpanel.cbk) { tibibu.inputpanel.cbk($("#inputpanel input").val());} }
    },
    prep : {
        last:"",
        timer: 0,
        list: [],
        selected: -1,
        svalue : "",
        tmp: [],
        save: function(_elt) {
            if (_elt.hasClass("s")) {
                var args = { action:"new", label:encodeURIComponent($("#buprender .butitle .title").text()),
                             level: $("buprender .butitle .levels .value").text(), classification: $("buprender .butitle .classification .value").text() };
                if ($("#bupmenu #bupid").hasClass("s")) { args.action="upd"; args.name=$("#bupmenu #bupid").text(); }

                user.getJSON("mods/tibibu/api/file.php", args, { data:tibibu.prep.list.join(',') },
                    function(_data) {
                        $("#bupmenu #bupid").html(_data.value).addClass("s");
                        $("#bupsave").removeClass("s");
                });
            }
        },
        slides: function(_elt) {
            $("#butoggle").hide();
            $("#buslider>div").slide('update',$(_elt).closest(".slides").find(".data").text()).parent().show();
        },
        send: function(_elt) {
            var ex = $(_elt).closest(".exercices").find(".data").text();
            if ($("#uflcircles").val()) {
                tibibu.message.init("exercice",true, function() {
                    user.getJSON("mods/tibibu/api/message.php", {
                        action:"new", circle:$("#uflcircles").val(), type:"exercice", label:$("#busendpanel input").val() }, {
                        description:$("#busendpanel").hasClass("d")?"":$("#busendpanel textarea").val(), data: ex },
                        function(_data) { tibibu.message.init("reset",false); });
                            
                });
            }
        },
        exercices: function(_elt) {
            $("#butoggle").hide();
            var ex = $(_elt).closest(".exercices").find(".data").text().split(','), state="";
            for (var i=0; i<ex.length; i++) { state+="."; }

            $("#buexercices #buex").menu({
                list    : ex,
                state   : state,
                onupdate: function($this, _state) {},
                onclick : function($this, _args)  {
                    $("#waiting").show().find("div").addClass("running");
                    $("#bulauncher").jlodb({
                            onstart:    function($this) { $("#buexercices").hide(); $("#waiting").hide().find("div").removeClass("running"); },
                            onfinish:   function($this) { $("#buexercices").show(); },
                            onscore:    function($this, _ret) {
                                var isnext = $("#buexercices #buex").menu('more');
                                if (_ret.score>=2) { $("#buexercices #buex").menu('score', _ret.score); }
                                if (isnext) { $("#buexercices #buex").menu('next'); }
                                else        { $("#buexercices").hide(); $("#butoggle").show(); }
                                return isnext; } },_args);
                    }
            }).parent().show();

        },
        up: function() {
            if (tibibu.prep.selected>1) {
                var sav = tibibu.prep.list[tibibu.prep.selected];
                tibibu.prep.list[tibibu.prep.selected]    = tibibu.prep.list[tibibu.prep.selected-1];
                tibibu.prep.list[tibibu.prep.selected-1]  = sav;
                $("#buprender #e"+tibibu.prep.selected).detach().insertBefore($("#buprender #e"+(tibibu.prep.selected-1)));
                tibibu.prep.selected--; tibibu.prep.display();
                $("#bupsave").addClass("s");
            }
        },
        down: function() {
            if (tibibu.prep.selected>0 && tibibu.prep.selected<tibibu.prep.list.length-1) {
                var sav = tibibu.prep.list[tibibu.prep.selected];
                tibibu.prep.list[tibibu.prep.selected]    = tibibu.prep.list[tibibu.prep.selected+1];
                tibibu.prep.list[tibibu.prep.selected+1]  = sav;
                $("#buprender #e"+tibibu.prep.selected).detach().insertAfter($("#buprender #e"+(tibibu.prep.selected+1)));
                tibibu.prep.selected++; tibibu.prep.display();
                $("#bupsave").addClass("s");
            }
        },
        deleteall: function() {
            if (tibibu.prep.timer) {
                clearTimeout(tibibu.prep.timer); tibibu.prep.timer = 0; $("#bupdeleteall").removeClass("s");
                tibibu.prep.init();
            }
            else {
                $("#bupdeleteall").addClass("s");
                tibibu.prep.timer = setTimeout(function() { $("#bupdeleteall").removeClass("s"); tibibu.prep.timer = 0; }, 500);
            }
        },
        remove: function() {
            if (tibibu.prep.timer) {
                if (tibibu.prep.selected!=-1) {
                    clearTimeout(tibibu.prep.timer); tibibu.prep.timer = 0; $("#bupremove").removeClass("s");
                    tibibu.prep.list.splice(tibibu.prep.selected,1);
                    $("#buprender #e"+tibibu.prep.selected).detach();
                    tibibu.prep.selected = -1; tibibu.prep.display();
                }
                $("#bupvalue").val("");
                tibibu.prep.tmp="";
                $('#buprender>.buprep>div.tmp').detach();
                $("#bupsave").addClass("s");
            }
            else {
                $("#bupremove").addClass("s");
                tibibu.prep.timer = setTimeout(function() { $("#bupremove").removeClass("s"); tibibu.prep.timer = 0; }, 500);
            }
        },
        export:function($_target){
            $_target.find("textarea").val(tibibu.prep.list.join(','));
            $_target.show();
        },
        tags : {
            list : function(_tag,_value, _offset) {
                var list = _value.substr(_offset, _value.indexOf("}}",_offset)-_offset);
                var elts = list.split("|");
                var html = "<ul>";
                for (var e in elts) {
                    ee = elts[e].split('=');
                    if (ee.length==1) { html+="<li>"+tibibu.format(ee[0])+"</li>"; }
                    else              { html+="<li><div class='number'>"+ee[0]+"</div>"+tibibu.format(ee[1])+"</li>" }
                }
                html+="</ul>";
                return { offset:_offset+list.length+2, html:$(html) };
            },
            html : function(_value,_offset) {
                var finished    = false;
                var global      = "error";

                // GET GLOBAL ELEMENT TAG
                if (_value.indexOf("{{")!=0) { _offset = -1; }
                else {
                    _offset+=2;
                    var pos = _value.indexOf("|",_offset);
                    if (pos!=-1) { global = _value.substr(_offset, pos -_offset); _offset+=global.length+1; }
                    else         { _offset=-1; }
                }

                // CHOOSE TEMPLATE
                var templates = {
                    comment:   "<div class='comment'><div><div class='text'></div></div></div>",
                    prep :      "<div class='level1 butitle'><div class='header'><div class='icon toggle1'><img src='res/img/white/minus.svg'/></div>"+
                                "<div class='mod title'></div></div><div class='attrs'>" +
                                "<div class='attr classification'><div class='label'>"+tibibu.locale.buprep.classification+"</div><div class='mod value'></div></div>"+
                                "<div class='attr levels'><div class='label'>"+tibibu.locale.buprep.levels+"</div><div class='value'></div></div>"+
                                "<div class='attr author'><div class='label'>"+tibibu.locale.buprep.author+"</div><div class='value'></div></div>"+
                                "</div>"+
                                "<div class='obj empty'><div class='label'>"+tibibu.locale.buprep.objectives+"</div><div class='value'></div></div>"+
                                "</div>",
                    session:    "<div class='level2 session'><div class='header'><div class='icon toggle'><img src='res/img/white/minus.svg'/></div>"+
                                "<div class='duration mod'></div><div class='title mod'></div></div>"+
                                "<div class='equ empty'><div class='label'>"+tibibu.locale.buprep.equipment+"</div><div class='value'></div></div>"+
                                "<div class='obj empty'><div class='label'>"+tibibu.locale.buprep.objectives+"</div><div class='value'></div></div>"+
                                "</div>",
                    step:       "<div class='level3 step'><div><div class='icon toggle alt2'><img src='res/img/icon/minus.svg'/></div><div class='duration mod'></div><div class='title mod'></div></div></div>",
                    exercices:  "<div class='exercices'><div class='com'><div class='actions'>"+
                                "<div onmousedown='tibibu.prep.exercices(this);event.stopPropagation();' ontouchstart='tibibu.prep.exercices(this);event.stopPropagation();event.preventDefault();'><img src='res/img/white/run.svg'/></div>"+
                                "<div></div><div onmousedown='tibibu.prep.send(this);event.stopPropagation();' ontouchstart='tibibu.prep.send(this);event.stopPropagation();event.preventDefault();'><img src='res/img/white/export.svg'/></div>"+
                                "</div><div class='label'>"+tibibu.locale.buprep.exercices+"</div><div class='data'></div></div></div>",
                    file:       "<div class='file'><div class='com'><div class='actions'>"+
                                "<div onmousedown='window.open($(this).closest(\".file\").find(\".data\").text(), \"_blank\").focus();event.stopPropagation();' "+
                                "    ontouchstart='window.open($(this).closest(\".file\").find(\".data\").text(), \"_blank\").focus();event.stopPropagation();event.preventDefault();'><img src='res/img/white/run.svg'/></div>"+
                                "<div></div><div onmousedown='event.stopPropagation();' ontouchstart='event.stopPropagation();event.PreventDefault();'><a href=\"\" download><img src='res/img/white/download.svg'/></a></div>"+
                                "</div><div class='label description'></div><div class='data'></div></div></div>",
                    slides:     "<div class='slides'><div class='com'><div class='actions'>"+
                                "<div onmousedown='tibibu.prep.slides(this);event.stopPropagation();' ontouchstart='tibibu.prep.slides(this);event.stopPropagation();event.preventDefault();'><img src='res/img/white/run.svg'/></div>"+
                                "</div><div class='label'>"+tibibu.locale.buprep.slides+"</div><div class='data'></div></div><div class='description'></div></div>",
                    generic:    "<div class='generic'><div class='"+global+"'>"+tibibu.locale.buprep[global]+"</div><div class='text'></div></div>",
                    error:      "<div class='error'>"+tibibu.locale.buprep.error+"</div>"
                };
                var $html=templates[global]?$(templates[global]):$(templates.generic);

                while (_offset<_value.length && _offset!=-1 && _value[_offset]!='}') {
                    var value ="";
                    // GET THE TAG
                    var tag = _value.substr(_offset, _value.indexOf("=",_offset)-_offset);
                    _offset+=tag.length+1;
                    var savOffset = _offset;

                    // GET THE VALUE (TAKE CARE ABOUT THE LIST)
                    if (_value[_offset]=='{') {
                        if (global=="slides" && tag=="data") {
                            // SPECIFIC TREATMENT FOR SLIDES BECAUSE OF ITS FORMAT {{}},{{}},{{}}
                            var end = _value.indexOf("}}}}",_offset), alt = _value.indexOf("}}|",_offset);
                            if (alt!=-1 && alt<end) { end = alt; }
                            end+=2;
                            value = _value.substr(_offset, end-_offset);
                            _offset+=value.length+1;
                        }
                        else {
                            _offset+=2;
                            var subtag = _value.substr(_offset, _value.indexOf("|",_offset)-_offset);
                            if (tibibu.prep.tags[subtag]) {
                                _offset+=subtag.length+1;
                                var parser = tibibu.prep.tags[subtag](subtag,_value, _offset);
                                _offset=parser.offset+1; value=parser.html;
                            }
                        }
                    }
                    else {
                        var end = _value.indexOf("}",_offset), alt = _value.indexOf("|",_offset);
                        if (alt!=-1 && alt<end) { end = alt; }
                        value = _value.substr(_offset, end-_offset);
                        _offset+=value.length+1;
                    }

                    // FILL THE ELEMENT
                    switch(tag) {
                        case "title":           $html.find(".title").html(tibibu.format(value)).addClass("mod").attr("id","c"+savOffset+"x"+(_offset-1)); break;
                        case "classification":  $html.find(".classification .value").html(value).addClass("mod").attr("id","c"+savOffset+"x"+(_offset-1)); break;
                        case "status":          break;
                        case "level":           $html.find(".levels .value").html(value).addClass("mod").attr("id","c"+savOffset+"x"+(_offset-1));break;
                        case "objectives":      $html.find(".obj .value").html(value); $html.find(".obj").removeClass("empty"); break;
                        case "duration":        value = parseInt(value); if (!value) { value=0; } $html.find(".duration").html(value); break;
                        case "text":            $html.find(".text").html(value).addClass("mod").attr("id","c"+savOffset+"x"+(_offset-1));break;
                        case "equipment":       $html.find(".equ .value").html(value); $html.find(".equ").removeClass("empty"); break;
                        case "data":            $html.find(".data").html(value); break;
                        case "url":             $html.find(".data").html(value); $html.find("a").attr("href",value); break;
                        case "description":     $html.find(".description").html(value); break;
                    }
                
                }
                if (_offset!=-1) {
                    _offset++;
                    if (_offset<2 || _value[_offset-1]!='}' || _value[_offset-2]!='}' ) { _offset=-1; }
                }
                return {offset:_offset, html:$html}
            }
        },
        tohtml: function(_value, _args, _parse) {
            var offset  = 0;
            var html    = "";

            while (offset!=-1 && offset<_value.length) {
                offset=_value.indexOf("{{",offset);
                if (offset!=-1) {
                    var parser = tibibu.prep.tags.html(_value, offset);
                    if (offset!=-1) {
                        if (_args && _args["id"])       { parser.html.attr("id", _args.id); }
                        if (_args && _args["class"])    { parser.html.addClass(_args["class"]); }
                        if (_parse) { _parse.push(_value.substr(offset, parser.offset-offset)); }
                        offset=parser.offset; html+=parser.html.prop('outerHTML');
                    }
                }
            };
            return html;
        },
        bind: function($_target, _select) {

            if (_select) {
                $_target.find(".buprep>div").unbind("mousedown touchstart");
                $_target.find(".buprep>div").bind("mousedown touchstart",function(_event) {
                    tibibu.prep.select("#bupvalues #s"+$(this).attr("id").substr(1));
                    _event.preventDefault();
                    _event.stopPropagation();
                });
            }

            $_target.find(".toggle1").unbind("mousedown touchstart");
            $_target.find(".toggle1").bind("mousedown touchstart",function(_event) {
                var $elt    = $(this).closest(".buprep>div");
                var closed  = $elt.hasClass("closed");
                $elt.parent().find(".level2").each(function() { tibibu.prep.toggleelt($(this), closed, false); });
                $elt.parent().find(".level3").each(function() { tibibu.prep.toggleelt($(this), closed, true); });
                    
                if (closed) {
                    $elt.removeClass("closed");
                    $elt.find("img").attr("src", "res/img/white/minus.svg");
                }
                else {
                    $elt.addClass("closed");
                    $elt.find("img").attr("src", "res/img/white/add.svg");
                }
                _event.preventDefault();
                _event.stopPropagation();
            });

            $_target.find(".toggle").unbind("mousedown touchstart");
            $_target.find(".toggle").bind("mousedown touchstart",function(_event) {
                var $elt    = $(this).closest(".buprep>div");
                var closed  = $elt.hasClass("closed");
                    
                tibibu.prep.toggleelt($elt, closed, $(this).hasClass("alt2"));
                _event.preventDefault();
                _event.stopPropagation();
            });
        },
        toggleelt: function($_elt, _closed, _black) {
            var level   = function($_e) {
                var ret = 99;
                var i   = $_e.attr("class").indexOf("level");
                if (i!=-1) { ret = parseInt($_e.attr("class")[i+5]); }
                return ret;
            };

            var lvl     = level($_elt);
            var $next   = $_elt.next();

            while ($next.html() && level($next)>lvl) {
                if (_closed) $next.removeClass("hide"+lvl); else $next.addClass("hide"+lvl);
                $next = $next.next();
            }

            if (_closed) {
                $_elt.removeClass("closed");
                $_elt.find("img").attr("src", (_black?"res/img/icon/":"res/img/white/")+"minus.svg");
            }
            else {
                $_elt.addClass("closed");
                $_elt.find("img").attr("src", (_black?"res/img/icon/":"res/img/white/")+"add.svg");
            }
        },
        toggleview: function(_b, _elt) {
            if (_elt.hasClass("limited"))   { _elt.removeClass("limited");  _b.addClass("s"); }
            else                            { _elt.addClass("limited");     _b.removeClass("s");}
        },
        add : function(_id) {
            var data    = tibibu.locale.prep[_id][1];
            if (data.indexOf("{{slides|") == 0) { data = data.replace("$1", tibibu.slide.list.join(',') ); }
            $("#bupvalue").val(data);
            tibibu.prep.selected=-1;
            tibibu.prep.tmp = [];
            $("#bupvalues .s").removeClass("s");
            $("#buprender>.buprep>div.s").removeClass("s");
            $('#buprender>.buprep>div.tmp').detach();
            $('#buprender>.buprep').append(tibibu.prep.tohtml($("#bupvalue").val(), { "class": "tmp" }, tibibu.prep.tmp));
        },
        init : function(_args) {
            tibibu.prep.list=[];
            tibibu.prep.selected=-1;
            $("#bupvalue").val("");

            if (!_args) {
                for (var i in tibibu.locale.newprep) { tibibu.prep.list.push(tibibu.locale.newprep[i]); }
                var html="";
                for (var i=0; i<tibibu.prep.list.length; i++ ) { html+=tibibu.prep.tohtml(tibibu.prep.list[i]); }
                $('#buprender>.buprep').html(html);

                $("#bupmenu #bupid").html(tibibu.locale.locale.bupid).removeClass("s");
            }
            else {
                var html= tibibu.prep.tohtml(_args.data, { }, tibibu.prep.list);
                $('#buprender>.buprep').html(html);

                $("#bupmenu #bupid").html(_args.id).addClass("s");
            }
            tibibu.prep.bind($('#buprender'), true);
            $("#bupsave").removeClass("s");

            tibibu.prep.display();
        },
        display: function() {
            var html="";
            for (var i=0; i<tibibu.prep.list.length; i++) {
                $($("#buprender .buprep").children().get(i)).attr("id","e"+i);
                if (i) { html+=","; }
                html+="<span onclick='tibibu.prep.select(this)' id='s"+i+"'" +
                      (i==tibibu.prep.selected?" class='s'":"")+">"+tibibu.prep.list[i].substr(0,tibibu.prep.list[i].indexOf('|'))+"}}</span>";
            }
            $("#bupvalues").html(html);
        },
        select: function(_elt) {
            var selected = parseInt($(_elt).attr("id").substr(1));
            $("#bupvalues .s").removeClass("s");
            $("#buprender>.buprep>div.s").removeClass("s");
            tibibu.prep.tmp = "";
            $('#buprender>.buprep>div.tmp').detach();

            if (tibibu.prep.selected!=-1 && tibibu.prep.svalue!=$("#bupvalue").val()) {
                var $html = $(tibibu.prep.tohtml(tibibu.prep.list[tibibu.prep.selected]));
                $('#buprender>.buprep #e'+tibibu.prep.selected).html($html.html());
                tibibu.prep.bind($('#buprender'),true);
            }

            if (selected == tibibu.prep.selected) {
                tibibu.prep.selected=-1;
                $("#bupvalue").val("");
            }
            else {
                $(_elt).addClass("s");
                tibibu.prep.selected=selected;
                tibibu.prep.svalue = tibibu.prep.list[tibibu.prep.selected];
                $('#buprender>.buprep #e'+tibibu.prep.selected).addClass("s");
                $("#bupvalue").val(tibibu.prep.svalue);
            }
        },
        overview: function() {
            // MODIFICATION
            if (tibibu.prep.selected!=-1) {
                var $html = $(tibibu.prep.tohtml($("#bupvalue").val()));
                $('#buprender>.buprep #e'+tibibu.prep.selected).html($html.html());
            }
            // NEW ELEMENT
            else  {
                tibibu.prep.tmp = [];
                $('#buprender>.buprep>div.tmp').detach();
                $('#buprender>.buprep').append(tibibu.prep.tohtml($("#bupvalue").val(), { "class": "tmp" }, tibibu.prep.tmp));
            }
        },
        insert: function() {
           if (tibibu.prep.selected!=-1) {
                tibibu.prep.list[tibibu.prep.selected]=$("#bupvalue").val();
                $("#bupvalues .s").removeClass("s");
                $("#buprender>.buprep>div.s").removeClass("s");
            }
            else if (tibibu.prep.tmp.length) {
                var id=tibibu.prep.list.length;
                $('#buprender>.buprep>div.tmp').detach();
                for (var i=0; i<tibibu.prep.tmp.length; i++) {
                    tibibu.prep.list.push(tibibu.prep.tmp[i]);
                    $('#buprender>.buprep').append(tibibu.prep.tohtml(tibibu.prep.tmp[i]));
                }
                tibibu.prep.display();
                tibibu.prep.tmp = [];
            }
            tibibu.prep.bind($('#buprender'),true);
            $("#bupvalue").val("");
            $("#bupsave").addClass("s");
        },
        menu : function(_elt) {
            $(".bunav2>div").removeClass("s"); $(_elt).addClass("s");
            $(".bucontent").hide(); 
            switch($(_elt).attr("id")) {
                case "psmenu" :
                    user.getJSON("mods/tibibu/api/file.php", { action:"list"}, {}, function(_data) {
                        $("#bupresults").html("");
                        for (var i in _data.files) {
                            var $html=$("<div id='p"+_data.files[i].id+"'></div>");
                            if (_data.files[i].edit) { $html.append("<div class='e'><img src='res/img/white/edit.svg'/></div>"); }
                            $html.append("<span>"+_data.files[i].label+"</span>");
                            $html.bind("mousedown touchstart", function(_event) {
                                user.getJSON("mods/tibibu/api/file.php", {value: $(this).attr("id").substr(1) }, {}, function(_data) {
                                    $("#bupsrender>.buprep").html(tibibu.prep.tohtml(_data.description));
                                    tibibu.prep.bind($('#bupsrender'), true);
                                });
                                _event.preventDefault();
                                _event.stopPropagation();
                            });
                            $html.find(".e").bind("mousedown touchstart", function(_event) {
                                user.getJSON("mods/tibibu/api/file.php", {value: $(this).parent().attr("id").substr(1) }, {}, function(_data) {
                                    $(".bunav2>div").removeClass("s"); $(".bunav2 #ppmenu").addClass("s"); $(".bucontent").hide(); 
                                    tibibu.prep.init({id:_data.value, data:_data.description});
                                    $("#buprep").show();
                                });
                                _event.preventDefault();
                                _event.stopPropagation();
                            });
                            $("#bupresults").append($html);
                        }
                    });
                    $("#bupsearch").show();   break;
                case "pdmenu" : $("#buslide").show();   break;
                case "ppmenu" : $("#buprep").show();    break;
            }
        }
    },
    friend: {
        menu: function(_elt) {
            $(".bunav2>div").removeClass("s"); $(_elt).addClass("s");
            $(".bucontent").hide(); 
            switch($(_elt).attr("id")) {
                case "bufsmenu" : user.friend.open("ufspanel"); break;
                case "bufamenu" : user.friend.open("ufapanel"); break;
                case "bufpmenu" : user.friend.open("ufppanel"); break;
                case "buflmenu" : user.friend.open("uflpanel"); break;
            }
        }
    },
    slide : {
        list: [],
        selected : -1,
        timer:0,
        last: "",
        export:function($_target){
            $_target.find("textarea").val(tibibu.slide.list.join(','));
            $_target.show();
        },
        up: function() {
            if (tibibu.slide.selected!=-1 && tibibu.slide.selected>0) {
                var sav = tibibu.slide.list[tibibu.slide.selected];
                tibibu.slide.list[tibibu.slide.selected]    = tibibu.slide.list[tibibu.slide.selected-1];
                tibibu.slide.list[tibibu.slide.selected-1]  = sav;
                tibibu.slide.selected--; tibibu.slide.display();
            }
        },
        down: function() {
            if (tibibu.slide.selected!=-1 && tibibu.slide.selected<tibibu.slide.list.length-1) {
                var sav = tibibu.slide.list[tibibu.slide.selected];
                tibibu.slide.list[tibibu.slide.selected]    = tibibu.slide.list[tibibu.slide.selected+1];
                tibibu.slide.list[tibibu.slide.selected+1]  = sav;
                tibibu.slide.selected++; tibibu.slide.display();
            }
        },
        deleteall: function() {
            if (tibibu.slide.timer) {
                clearTimeout(tibibu.slide.timer); tibibu.slide.timer = 0; $("#fpdeleteall").removeClass("s");
                tibibu.slide.selected = -1; tibibu.slide.list=[]; tibibu.slide.display(); $("#pdvalue").val("");
                tibibu.slide.overview(false);
            }
            else {
                $("#fpdeleteall").addClass("s");
                tibibu.slide.timer = setTimeout(function() { $("#fpdeleteall").removeClass("s"); tibibu.slide.timer = 0; }, 500);
            }
        },
        remove: function() {
            if (tibibu.slide.selected!=-1) {
                if (tibibu.slide.timer) {
                    clearTimeout(tibibu.slide.timer); tibibu.slide.timer = 0; $("#fpremove").removeClass("s");
                    tibibu.slide.list.splice(tibibu.slide.selected,1);
                    tibibu.slide.selected = -1; tibibu.slide.display(); $("#pdvalue").val("");
                    tibibu.slide.overview(false);
                }
                else {
                    $("#fpremove").addClass("s");
                    tibibu.slide.timer = setTimeout(function() { $("#fpremove").removeClass("s"); tibibu.slide.timer = 0; }, 500);
                }
            }
        },
        select: function(_elt) {
            var selected = parseInt($(_elt).attr("id").substr(1));
            $("#busvalues .s").removeClass("s");
            if (selected == tibibu.slide.selected) {
                tibibu.slide.selected=-1;
                $("#pdvalue").val("");
            }
            else {
                $(_elt).addClass("s");
                tibibu.slide.selected=selected;
                $("#pdvalue").val(tibibu.slide.list[tibibu.slide.selected]);
            }
            tibibu.slide.overview(false);
        },
        insert: function() {
            if ($("#pdvalue").val().length) {
                var regExp = new RegExp("({{[^}^}]+}})","g");
                var value = $("#pdvalue").val();
                var match = regExp.exec(value);
                while(match) {
                    if (tibibu.slide.selected>=0 && tibibu.slide.selected<tibibu.slide.list.length) {
                        tibibu.slide.list[tibibu.slide.selected] = match[1];
                    }
                    else { tibibu.slide.list.push(match[1]); }
                    match = regExp.exec(value);
                }
                $("#pdvalue").val(""); $("#busvalues .s").removeClass("s"); tibibu.slide.selected=-1;
                tibibu.slide.display();
                tibibu.slide.overview(false);
            }
        },
        display: function() {
            $("#busvalues").html("");
            for (var i=0; i<tibibu.slide.list.length; i++) {
                if (i>0) { $("#busvalues").append(","); }
                var value = tibibu.slide.list[i].substr(0, tibibu.slide.list[i].indexOf('|'));
                $("#busvalues").append("<span onclick='tibibu.slide.select(this)' id='s"+i+"'" +
                                      (i==tibibu.slide.selected?" class='s'":"")+">"+value+"}}</span>");
            }
        },
        overview: function(_all, _args) {
            if (!_args) {_args={}; }
            var value = _all?tibibu.slide.list.join(','):$("#pdvalue").val();
            var ok    = true;
            if (_all) { $("#pdvalue").val(""); $("#busvalues .s").removeClass("s"); tibibu.slide.selected=-1; }
            else      { _args.nonext = true; ok=(tibibu.slide.last != value);}
            tibibu.slide.last = value;
            if (ok) { $("#busoverview>div").slide('update',value, _args); }
        }
    },
    message: {
        type : "",
        cbk  : 0,
        data : 0,
        init: function(_type, _show, _cbk) {
            if (_type=="reset" || tibibu.message.type!=_type) {
                if (_type=="reset") { type = tibibu.message.type; }
                $("#busendpanel").addClass("d");
                $("#busendpanel input").val(tibibu.locale.message[_type]);
                $("#busendpanel textarea").val(tibibu.locale.message.comment);
                tibibu.message.type = _type;
                if (_cbk) { tibibu.message.cbk = _cbk; }
            }
            if (_show) { $("#busendpanel").show(); }
        },
        focus: function() {
            if ($("#busendpanel").hasClass("d")) { $("#busendpanel textarea").val(""); }
            $("#busendpanel").removeClass("d");
        },
        send : function() {
            $("#busendpanel").hide();
            if (tibibu.message.cbk) { tibibu.message.cbk(); }
        },
        reply: function() {
            switch (tibibu.message.data.type) {
                case "text":
                    tibibu.message.init("text",true, function() {
                        alert("yop");
                    });
                break;
                case "exercice":
                    $("#buexercices #buex").menu({
                        list    : atob(tibibu.message.data.data).split(','),
                        state   : ".....",
                        onupdate: function($this, _state) {},
                        onclick : function($this, _args)  {
                            $("#waiting").show().find("div").addClass("running");
                            $("#bulauncher").jlodb({
                                    onstart:    function($this) { $("#buexercices").hide(); $("#waiting").hide().find("div").removeClass("running"); },
                                    onfinish:   function($this) { $("#buexercices").show(); },
                                    onscore:    function($this, _ret) {
                                        var isnext = $("#buexercices #buex").menu('more');
                                        if (_ret.score>=2) { $("#buexercices #buex").menu('score', _ret.score); }
                                        if (isnext) { $("#buexercices #buex").menu('next'); }
                                        else        { $("#buexercices").hide(); $("#butoggle").show(); }
                                        return isnext; } },_args);
                            }
                    }).parent().show();
                break;
            }
        },
        open: function(_id) {
            $("#buicontent").html("");
            user.getJSON("mods/tibibu/api/message.php", {"value":_id }, {}, function(_data) {
                $("#buicontent").html(_data.value);
                $("#builaunch").show();
                tibibu.message.data = _data;
                //alert(atob(_data.data));
            });
        },
        menu : function(_elt) {
            $(".bunav2>div").removeClass("s"); 
            switch($(_elt).attr("id")) {
                case "mwmenu" :
                    if ($("#uflcircles").val()) {
                        tibibu.message.init("text",true, function() {
                            user.getJSON("mods/tibibu/api/message.php", {
                                action:"new", circle:$("#uflcircles").val(), type:"text", label:$("#busendpanel input").val() }, {
                                description:$("#busendpanel").hasClass("d")?"":$("#busendpanel textarea").val() },
                                function(_data) {
                                    tibibu.message.init("reset",false);
                                });
                            
                        });
                    }
                    break;
                case "mimenu":
                        $(_elt).addClass("s");
                        user.getJSON("mods/tibibu/api/message.php", { action:"inbox" }, {},
                        function(_data) {
                            $("#buimessage").html("");
                            for (var i in _data.messages) {
                                var $html=$("<div class='bumsg "+_data.messages[i].type+"'></div>");
                                $html.append("<div class='id'>"+_data.messages[i].id+"</div>");
                                $html.append("<div class='icon'><img src='res/img/white/"+(_data.messages[i].group?"newpeople":"people2")+".svg'/></div>");
                                $html.append("<div class='label'>"+_data.messages[i].label+"</div>");
                                $html.bind("mousedown touchstart", function(_event) {
                                    $("#buimessage>div").removeClass("s");
                                    $(this).addClass("s");
                                    tibibu.message.open($(this).find(".id").text());
                                    _event.preventDefault();
                                    _event.stopPropagation();
                                });
                                $("#buimessage").append($html);
                                $("#buicontent").html(""); $("#builaunch").hide();
                            }
                            $(".bucontent").hide(); $("#buinbox").show();
                        });
                    break;
            }
        }
    },
    board: {
        $this   : 0,
        svg     : 0,
        question: 0,
        onload  : function($this, _svg) {
            tibibu.board.$this  = $this;
            tibibu.board.svg    = _svg;
            var $html=$("<div id='budrawsend' class='icon column panel a d r'>"+
                        "<img src='res/img/svginventoryicons/tool/envelope01.svg'/></div>");
            $html.bind("mousedown touchstart", function(_event) {
                if (!$(this).hasClass("d")) {
                    tibibu.message.init("draw",true, function() {
                        var html = $("#foreground",tibibu.board.svg.root()).html();
                        var vReg = new RegExp("([.][0-9][0-9])[0-9]+","g");
                        html = html.replace(vReg,"$1");

                        user.getJSON("mods/tibibu/api/message.php", {
                            action:"new", circle:$("#uflcircles").val(), type:"draw", label:$("#busendpanel input").val() }, {
                            description:$("#busendpanel").hasClass("d")?"":$("#busendpanel textarea").val(), data:html },
                            function(_data) { tibibu.message.init("reset",false); });
                        
                    });
                }
                _event.preventDefault();
                _event.stopPropagation();
            });
            $("#budraw #menu").append($html);
        },
        onchange: function($this, _svg) {
            var cansave = false;
            if ($("#bumain").hasClass("devmode")) {
                if ($("#foreground", tibibu.board.svg.root()).children().length && $("#uflcircles").val()) {
                    cansave = true;
                }
            }
            else { }

            if (cansave)    { tibibu.board.$this.find("#budrawsend").removeClass("d"); }
            else            { tibibu.board.$this.find("#budrawsend").addClass("d"); }
        }
    }
};


$(window).ready(function() {

    // SPECIAL STUFF
    $("#activity").ontouchmove = function(e) { e.preventDefault(); }

    // PREPARE SLIDE
    $("#busoverview>div").slide({quit:false, context:{onquit:function(){}}});

    $.getJSON("api/checkdb.php", function (_check) {
        if (_check.status=="success") {
            // GLOBAL DATA
            tibibu.lang=_check.lang;
            tibibu.url =_check.url;

            // USER HANDLER INITIALISATION
            user.waiting    = "#waiting";
            
            user.onrequest = function() { $(user.waiting+" div").addClass("running"); $(user.waiting).show(); };
            user.onreply = function() { $(user.waiting+" div").removeClass("running"); $(user.waiting).hide(); };
            user.onuser = function(_user, _args, _elt) {
                if (_args.type=="list") {
                    var $html=$("<div class='icon mail'><img src='res/img/white/mail.svg'/></div>");
                    $html.bind("mousedown touchstart", function(_event) {
                        var key = $(this).closest(".user").attr("id").substr(1);
                        tibibu.message.init("text",true, function() {
                            user.getJSON("mods/tibibu/api/message.php", {
                                action:"new", target:key, type:"text", label:$("#busendpanel input").val() }, {
                                description:$("#busendpanel textarea").val() },
                                function(_data) { tibibu.message.init("reset",false); });
                        });
                        _event.preventDefault();
                        _event.stopPropagation();
                    });
                    _elt.find(".legend").append($html);
                }
            };

            user.inputpanel = tibibu.inputpanel.open;

            user.load.edit($("#butoggle"));
            user.load.devmode($("#butoggle"));

            user.circle.onselect = function(_key) {
                $("#butarget").html(_key?$("#uflcircles option:selected").html():tibibu.locale.locale.butarget);
                tibibu.board.onchange();
            }
        
            user.load.logpanel($("#butoggle"), {}, function() { user.init(tibibu.lang);
                user.load.friend($("#butoggle"), function() { $(".ufcontent").addClass("bucontent");
                
                    // LOCALISATION
                    $.getJSON("mods/tibibu/locale/"+_check.lang+"/text.json?debug="+Math.floor(Math.random()*1000), function(_locale) {
                        for (var i in _locale.locale) { if (typeof(_locale.locale[i])== "string") $("#"+i).html(_locale.locale[i]); }

                        // SLIDE LOCALE
                        $("#buslist").html("");
                        var nb = 0;
                        for (var i in _locale.slide) {
                            var $elt = $("<div onclick='$(\"#pdvalue\").val(\""+_locale.slide[i]+"\");tibibu.slide.overview(false);'>"+i+"</div>");
                            if (nb++%2) { $elt.addClass("s"); }
                            $("#buslist").append($elt);
                        }

                        // PREP LOCALE
                        for (var i=0; i<_locale.prep.length; i++) {
                            var $elt = $("<div onclick='tibibu.prep.add("+i+");'>"+_locale.prep[i][0]+"</div>");
                            if (i%2) { $elt.addClass("s"); }
                            $("#buplist").append($elt);
                        }

                        tibibu.locale = _locale;
                        $("#uflheader").addClass("devmode"); $("#uflfooter").addClass("devmode");

                        $("#buboard").show();
                        $("#budraw").draw({size:[480,480],context:{
                            onquit:     function() {},
                            onchange:   tibibu.board.onchange,
                            onload:     tibibu.board.onload }});

                        
                        $("#buslider>div").slide({draw:true,context:{onquit:function(){ $("#buslider").hide(); $("#butoggle").show(); }}});
                    });
                });
            });

        }
        else {
            $("#bumain").html(_check.status+": "+_check.textStatus);
        }
    });


    // GET AND RESIZE THE BEST PANEL
    var x = Math.floor($(window).width()/16);
    var y = Math.floor($(window).height()/12);
    $("body").css("font-size", (Math.min(x,y))+"px");
    $("#bumain").css("margin-top", Math.floor(($(window).height()-$("#bumain").height())/2-2)+"px").show();


});
    </script>

</head>

<body>
    <div id="bumain"><div>
        <div id="butoggle">

        <!-- NAVIGATION LEFT MENU -->
        <div id="bunav">
            
            <!-- USER PROFILE -->
            <div id="profile">
                <div id="avatar" ontouchstart="user.edit.open();event.preventDefault();"
                    onmousedown="user.edit.open();"></div>
                <div id="label">
                    <div id="name">&nbsp;</div>
                    <div id="sub"></div>
                    <div id="edmode" class="icon" ontouchstart="tibibu.devmode();event.preventDefault();"
                        onmousedown="tibibu.devmode();"><img src="res/img/white/edit.svg"/></div>
                </div>
                <div id="gdx" class="icon" ontouchstart="user.logout($(this));event.preventDefault();"
                    onmousedown="user.logout($(this));"><img src="res/img/white/logout.svg"/></div>
            </div>

            <!-- MAIN MENU -->
            <div id="umenu">
                <div id="ubmenu" class="bu bluekeypad" onmousedown="tibibu.menu(this);" ontouchstart="tibibu.menu(this);event.preventDefault();">
                    <div id="ublabel"></div>
                </div>
                <div id="ufmenu" class="bu bluekeypad" onmousedown="tibibu.menu(this);" ontouchstart="tibibu.menu(this);event.preventDefault();">
                    <div id="uflabel"></div><div class="alert"></div></div>
                <div id="friend" class="bunav2">
                    <div id="bufsmenu" class="devmode" onmousedown="tibibu.friend.menu(this);" ontouchstart="tibibu.friend.menu(this);event.preventDefault();"><div id="fslabel"></div></div>
                    <div id="bufamenu" class="devmode" onmousedown="tibibu.friend.menu(this);" ontouchstart="tibibu.friend.menu(this);event.preventDefault();"><div id="falabel"></div></div>
                    <div id="bufpmenu" onmousedown="tibibu.friend.menu(this);" ontouchstart="tibibu.friend.menu(this);event.preventDefault();"><div id="fplabel"></div><div class="alert"></div></div>
                    <div id="buflmenu" onmousedown="tibibu.friend.menu(this);" ontouchstart="tibibu.friend.menu(this);event.preventDefault();"><div id="fllabel"></div></div>
                </div>

                <div id="ummenu" class="bu bluekeypad" onmousedown="tibibu.menu(this);" ontouchstart="tibibu.menu(this);event.preventDefault();">
                    <div id="umlabel"></div></div>
                <div id="ummessage" class="bunav2">
                    <div id="mwmenu" class="devmode" onmousedown="tibibu.message.menu(this);" ontouchstart="tibibu.message.menu(this);event.preventDefault();"><div id="mwlabel"></div></div>
                    <div id="momenu" class="devmode" onmousedown="tibibu.message.menu(this);" ontouchstart="tibibu.message.menu(this);event.preventDefault();"><div id="molabel"></div></div>
                    <div id="mimenu" onmousedown="tibibu.message.menu(this);" ontouchstart="tibibu.message.menu(this);event.preventDefault();"><div id="milabel"></div><div class="alert"></div></div>
                </div>

                <div id="upmenu" class="bu bluekeypad devmode" onmousedown="tibibu.menu(this);" ontouchstart="tibibu.menu(this);event.preventDefault();">
                    <div id="uplabel"></div>
                </div>
                <div id="prep" class="bunav2">
                    <div id="psmenu" onmousedown="tibibu.prep.menu(this);" ontouchstart="tibibu.prep.menu(this);event.preventDefault();"><div id="pslabel"></div></div>
                    <div id="pdmenu" onmousedown="tibibu.prep.menu(this);" ontouchstart="tibibu.prep.menu(this);event.preventDefault();"><div id="pdlabel"></div></div>
                    <div id="ppmenu" onmousedown="tibibu.prep.menu(this);" ontouchstart="tibibu.prep.menu(this);event.preventDefault();"><div id="pplabel"></div></div>
                    <!-- <div id="pbmenu" onmousedown="tibibu.prep.menu(this);" ontouchstart="tibibu.prep.menu(this);event.preventDefault();"><div id="pblabel"></div></div> -->
                </div>
            </div>
            <div id="butarget" class="devmode"></div>
        </div>

        <div class="bucontent nosplash" id="buboard"><div id="buborder"></div><div id="budraw"></div>
        </div>

        <div class="bucontent" id="buslide">
            <div id="buscontent">
                <div id="busbutton">
                    <div class="bu icon" onmousedown="tibibu.slide.overview(true);" ontouchstart="tibibu.slide.overview(true);event.preventDefault();"><img src="res/img/white/run.svg"></div>
                    <div class="bu icon" onmousedown="tibibu.slide.export($('#outputpanel'));" ontouchstart="tibibu.slide.export($('#outputpanel'));event.preventDefault();"><img src="res/img/white/export.svg"></div>
                    <div class="bu icon" id="fpdeleteall" onmousedown="tibibu.slide.deleteall();" ontouchstart="tibibu.slide.deleteall();event.preventDefault();"><img src="res/img/white/delete.svg"></div>
                </div>
                <div id="busvalues"></div>
            </div>
            <div id="pdwrite">
                <div id="buslist"></div>
                <textarea id="pdvalue" onkeyup="tibibu.slide.overview(false, {keep:true});"></textarea>
                <div id="busaction">
                    <div class="bu icon" onmousedown="tibibu.slide.insert();" ontouchstart="tibibu.slide.insert();event.preventDefault();"><img src="res/img/white/valid.svg"></div>
                    <div class="bu icon" onmousedown="tibibu.slide.up();" ontouchstart="tibibu.slide.up();event.preventDefault();"><img src="res/img/white/up.svg"></div>
                    <div class="bu icon" onmousedown="tibibu.slide.down();" ontouchstart="tibibu.slide.down();event.preventDefault();"><img src="res/img/white/down.svg"></div>
                    <div class="bu icon" id="fpremove" onmousedown="tibibu.slide.remove();" ontouchstart="tibibu.slide.remove();event.preventDefault();"><img src="res/img/white/delete.svg"></div>
                </div>
            </div>
            <div id="busoverview"><div></div></div>
        </div>

        
        <div class="bucontent" id="buinbox">
            <div id="buiheader">
                <div id="buimessage" class="confidential"></div>
                <div id="buimenu"></div>
            </div>
            <div id="buicontent"></div>
            <div id="builaunch" onmousedown="tibibu.message.reply();" ontouchstart="tibibu.message.reply();event.preventDefault();"><div class='icon'><img src='res/img/white/run.svg'/></div></div>
        </div>

        <div class="bucontent" id="buprep">
            <div id="bupmenu" class="bupmenu">
                <div id="bupvalues"></div>
                <div id="bupid"></div>
                <div class="bupcontrol">
                    <div class='icon s' onmousedown="tibibu.prep.toggleview($(this), $('#buprender'));"><img src='res/img/white/eye.svg'/></div>
                    <div class='icon' onmousedown="tibibu.prep.export($('#outputpanel'));" ontouchstart="tibibu.prep.export($('#outputpanel'));event.preventDefault();"><img src="res/img/white/export.svg"></div>
                    <div class='icon' id="bupsave" onmousedown="tibibu.prep.save($(this));" ontouchstart="tibibu.prep.save($(this));event.preventDefault();"><img src="res/img/white/download.svg"></div>
                    <div class='icon' id="bupdeleteall" onmousedown="tibibu.prep.deleteall();" ontouchstart="tibibu.prep.deleteall();event.preventDefault();"><img src="res/img/white/delete.svg"></div>
               </div>
                <div id="buplist"></div>
                <textarea id="bupvalue" onkeyup="tibibu.prep.overview();"></textarea>
                <div id="bupbuttons">
                    <div class="icon" onmousedown="tibibu.prep.insert();" ontouchstart="tibibu.prep.insert();event.preventDefault();"><img src="res/img/white/valid.svg"></div>
                    <div class="icon" onmousedown="tibibu.prep.up();" ontouchstart="tibibu.prep.up();event.preventDefault();"><img src="res/img/white/up.svg"></div>
                    <div class="icon" onmousedown="tibibu.prep.down();" ontouchstart="tibibu.prep.down();event.preventDefault();"><img src="res/img/white/down.svg"></div>
                    <div class='icon' id="bupremove" onmousedown="tibibu.prep.remove();" ontouchstart="tibibu.prep.remove();event.preventDefault();"><img src="res/img/white/delete.svg"></div>
                </div>
            </div>
            <div id="buprender" class="buprender"><div class="buprep"></div></div>
        </div>

        <div class="bucontent" id="bupsearch">
            <div class="bupmenu">
                <div id="bupargs"></div>
                <div class="bupcontrol">
                    <div class='icon s' onmousedown="tibibu.prep.toggleview($(this), $('#bupsrender'));"><img src='res/img/white/eye.svg'/></div>
                </div>
                <div id="bupresults"></div>
            </div>
            <div id="bupsrender" class="buprender"><div class="buprep"></div></div>
        </div>


        </div>

        <div id="buslider" class="bupanel"><div></div></div>

        <div id="buexercices" class="bupanel theme2">
            <div class="buquit" ontouchstart="$(this).parent().hide();$('#butoggle').show();event.preventDefault();"
                           onmousedown="$(this).parent().hide();$('#butoggle').show();"><img src="res/img/icon/quit.svg"/></div>
            <div id="buex"></div>
        </div>

        <div id="bulauncher" class="bupanel">
            <div class="buquit" ontouchstart="$('#bulauncher').jlodb('quit');event.preventDefault();"
                           onmousedown="$('#bulauncher').jlodb('quit');"><img src="res/img/icon/quit.svg"/></div>
            <div id="activity"></div>
        </div>

        <div id="inputpanel" class="inputpanel" onmousedown="$(this).hide();" ontouchstart="$(this).hide();event.preventDefault();"><div>
            <input type="text"
                onmousedown="$(this).focus();event.stopPropagation();"
                ontouchstart="$(this).focus();event.stopPropagation();event.preventDefault();"/>

            <div class="icon" onmousedown="tibibu.inputpanel.valid();event.stopPropagation();"
                              ontouchstart="tibibu.inputpanel.valid();event.stopPropagation();event.preventDefault();">
                <img src="user/res/img/valid.svg"/>
            </div>
        </div></div>

        <div id="busendpanel" class="inputpanel d" onmousedown="$(this).hide();" ontouchstart="$(this).hide();event.preventDefault();"><div>
            <input type="text"
                onmousedown="$(this).focus();tibibu.message.focus();event.stopPropagation();"
                ontouchstart="$(this).focus();tibibu.message.focus();event.stopPropagation();event.preventDefault();"/>
            <div class="icon" onmousedown="tibibu.message.send();event.stopPropagation();"
                              ontouchstart="tibibu.message.send();event.stopPropagation();event.preventDefault();">
                <img src="user/res/img/valid.svg"/>
            </div>
            <textarea
                onmousedown="$(this).focus();tibibu.message.focus();event.stopPropagation();"
                ontouchstart="$(this).focus();tibibu.message.focus();event.stopPropagation();event.preventDefault();"></textarea>
        </div></div>

        <div id="outputpanel" class="inputpanel" onmousedown="$(this).hide();" ontouchstart="$(this).hide();event.preventDefault();"><div>
            <textarea onmousedown="$(this).focus();event.stopPropagation();"
                      ontouchstart="$(this).focus();event.stopPropagation();event.preventDefault();"></textarea>
        </div></div>

        <div id="waiting" class="anim12"><div><img src="res/img/generic/waiting_red.svg"/></div></div>

    </div></div>
</body>
